\documentclass[12pt,modern]{aastex61}
\usepackage{graphics,graphicx}
\usepackage{hyperref}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{comment}
\usepackage{grffile} % checks for multiple dots in figure filenames
\usepackage{empheq} % for boxing equations
\newcommand*\widefbox[1]{\fbox{\hspace{0.2cm}#1\hspace{0.2cm}}}

%% Reintroduced the \received and \accepted commands from AASTeX v5.2
%\received{July 1, 2016}
%\revised{September 27, 2016}
%\accepted{\today}
%% Command to document which AAS Journal the manuscript was submitted to.
%% Adds "Submitted to " the arguement.
\submitjournal{AAS journals.}


\shortauthors{Bouma et al.}
\shorttitle{Binarity and Occurrence Rates}


\newcommand{\pp}{\mathcal{P}}
\newcommand{\ps}{\mathcal{S}}
\renewcommand{\a}{_{\rm a}}
\newcommand{\s}{_{\rm s}}
\newcommand{\p}{_{\rm p}}
\renewcommand{\d}{_{\rm d}}
\begin{document}
    
\title{ The effects of binarity on planet occurrence rates measured by transit 
surveys}
%
\correspondingauthor{L. Bouma}
\email{luke@astro.princeton.edu}
%
\author{L. G. Bouma}
\affiliation{
    Department of Astrophysical Sciences,
    Princeton University,
    4 Ivy Lane, Princeton, NJ 08540, USA}
\author{K. Masuda}
\affiliation{
    Department of Astrophysical Sciences,
    Princeton University,
    4 Ivy Lane, Princeton, NJ 08540, USA}
\author{J. N. Winn}
\affiliation{
    Department of Astrophysical Sciences,
    Princeton University,
    4 Ivy Lane, Princeton, NJ 08540, USA}
%
%
\begin{abstract}
%
This study develops simplified models of signal-to-noise limited transit 
surveys, in order to clarify the biases that stellar binarity introduces
to occurrence rate measurements.
We pay particular attention to dilution of observed planet radii, errors in 
star counts, and treatment of detection efficiencies.
Given a plausible set of assumptions, we derive a general formula 
for the apparent rate density, which depends on the true 
planet radius distribution, and also the relative numbers of planets 
orbiting secondaries, primaries, and single stars.
From this formalism, we suggest that for most of the observed radius 
distribution (apparent planet radii $>2r_\oplus$), ignoring binarity 
leads to errors in inferred occurrence rates at the $\lesssim 10\%$ level.
One corollary is that binarity seems unlikely to strongly influence any 
discrepancy between transit survey and RV survey hot Jupiter rates.
The errors created by ignoring binarity at smaller apparent radii might be 
larger: for instance, the absolute occurrence of Earth-sized planets could be 
overestimated by $\lesssim 50\%$.
Under our formalism, we also show that if high-resolution imaging reveals 
stellar neighbors of detected planets, the planet is usually more likely to 
orbit the primary. We explore how this statement depends on the
apparent radius of the detected planet.
%
\end{abstract}
%
\keywords{
    methods: data analysis ---
    planets and satellites: detection ---
    surveys}
%
%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\input{introduction}

\section{Introduction}

A group of binarity-ignoring astronomers wants to measure the mean number of 
planets of a certain type per star of a certain type.
They perform a wide-field photometric search for planets that transit, and 
discover all for which
\begin{equation}
\left(\frac{{\rm S}}{{\rm N}}\right)
= ({\rm const}) \cdot \delta_{\rm obs} L_{\rm sys}^{1/2} d^{-1}
> \left(\frac{{\rm S}}{{\rm N}}\right)_{\rm floor}.
\label{eq:S_N_thresh}
\end{equation}
The observed transit depth per unit stellar flux $\delta_{\rm obs}$ 
constitutes the signal, ${\rm S}$.
The survey is shot-noise dominated, and the fractional photon noise 
${\rm N}$ scales as the inverse root of the photon flux received from any 
stellar system, ${\rm N} \propto (L_{\rm sys}/d^2)^{-1/2}$, for $L_{\rm sys}$ 
the system luminosity and $d$ its distance.
The solid angle coverage, telescope area, and survey duration are part of the 
``const'' term of Eq.~\ref{eq:S_N_thresh}. The transit duration also 
affects detectability, but we omit it in this work for brevity.

To compute an occurrence, at every planetary and stellar property the 
astronomers choose the stars around which the planets of interest appeared to 
be searchable.
Correcting for the geometric transit probability $p_{\rm tra}$, they report an 
apparent rate density,
\begin{equation}
\Gamma\a(\pp\a, \ps\a) = \frac{n_{\rm det}(\pp\a, \ps\a)}{N_{\rm s,a}(\pp\a, 
    \ps\a)} \times \frac{1}{p_{\rm tra}(\pp\a, \ps\a)}.
\label{eq:defn_apparent_rate_density}
\end{equation}
where $\pp\a$, $\ps\a$ are the apparent planetary and stellar parameters.
The quantity $N_{\rm s,a}(\pp\a, \ps\a)$ is the number of unresolved 
point-sources on the sky that appear to be searchable, and
$n_{\rm det}(\pp\a, \ps\a)$ is the number of detected planets, per unit 
$\pp\a$ and $\ps\a$. 

There are many potential pitfalls.  Some genuine transit signals can be missed
by the detection pipeline.  Some apparent transit signals are spurious, from
noise fluctuations, failures of `detrending', or instrumental effects.  Stars
and planets can be misclassified due to statistical and systematic errors in
the measurements of their properties.  Poor angular resolution causes false
positives due to blends with background eclipsing binaries. {\it Et cetera}.

Here we focus on problems that arise from the fact that many stars exist in 
multiple star systems.
For simplicity, we consider only binaries, and we assume that they are all 
bound and spatially unresolved.

An immediate complication is that, due to dynamical stability or some 
aspect of planet formation, the occurrence rate of planets might differ 
between binary and single-star systems.
In an observed sample of stars that contains both singles and binaries, the 
detected planets would then be drawn from different intrinsic 
distributions for the occurrence rates in single star systems, 
about primaries, and about secondaries~\citep[{\it 
e.g.},][]{wang_occurrence_2015}.

Outside of astrophysical differences, every term in 
Eq.~\ref{eq:defn_apparent_rate_density} is observationally-biased.
There are errors in $n_{\rm det}(\pp\a,\ps\a)$ due to misclassification of 
both planet radii and stellar properties.
There are errors in $N_{{\rm s,a}}(\pp\a,\ps\a)$ because a 
searchable point on the sky might be two searchable stars.
Finally, there are errors in $p_{\rm tra}(\pp\a,\ps\a)$ because stars in 
binaries may have different masses and radii than assumed in the single-star 
case.

Correcting for binarity's observational biases is non-trivial.
For instance, in counting the number of searchable stars, even after realizing 
that binaries count as two stars, one must note that the multiplicity fraction 
of stars that are searchable for a given observed transit depth is greater 
than the multiplicity fraction in a volume limited sample.
This is the familiar Malmquist bias: at a fixed $\delta_{\rm obs}$, binaries 
are searchable out to larger distances than single stars because they are more 
luminous.
A separate effect is that the apparent radii assigned to planets in binaries 
will typically be smaller than the true radii.
Correcting for ``radius dilution'' requires knowing both the amount flux 
contributed by each source in a photometric aperture, and which star the 
planet orbits.


To gain intuition for the many observational biases at play,
we consider a set of idealized transit surveys.
First, we discuss the simplest possible cases (Sec.~\ref{sec:simplest}), in 
which all planets have identical properties, and all stars have identical 
properties except that some are in binary systems.
We generalize these thought-experiments in 
Sec.~\ref{sec:general_formula} to allow for realistic stellar populations with 
arbitrary occurrence rate distributions.
Sec.~\ref{sec:more_complicated} explores the implications for
(a) measurements of $\eta_\oplus$,
(b) the ``hot Jupiter rate discrepancy'', and 
(c) \citet{fulton_california-_2017}'s recently discovered ``valley''.
We discuss what our models suggest about the importance of binarity's biases 
in Sec.~\ref{sec:discussion}, and conclude in Sec.~\ref{sec:conclusion}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\input{methods}

\section{The simplest possible transit survey models}
\label{sec:simplest}

\subsection{Twin binaries, identical stars, identical planets}
\label{sec:model_1}

\begin{figure}[!tb]
    \begin{center}
        \includegraphics[width=0.6\textwidth]{figures/visualize_volumes.pdf}
    \end{center}
    \caption{
        Cartoon of the searchable volumes for single stars ({\it left}), and 
        twin binaries ({\it right}).
        This model assumes all stars have equal mass and luminosity, and 
        all planets have the same true radius $r=r\p$.
        {\it Top:} At an apparent radius $r\a=r\p$,
        the observer searched twin binaries out to a
        distance $\sqrt{2}\times$ that of single stars.
        Because of dilution, there are no planets in twin binaries with 
        $r\a=r\p$.
        {\it Middle:} At an apparent radius $r\a=r\p/\sqrt{2}$, the 
        maximum searchable distances are half those at $r\a=r\p$. 
        The only detected planets with $r\a=r\p/\sqrt{2}$ orbit twin binaries.
        {\it Bottom:} Planets with a true radius $r=r\p$ are searchable to 
        a maximum distance $d_0$ around singles, and $d_0/\sqrt{2}$ around 
        twin binaries.
    }
    \label{fig:model_1_volumes}
\end{figure}

Since the effects of binarity are most pronounced when the two components are 
similar, we begin by considering a universe in which all planets are 
identical, and all stars are identical except that some fraction of them exist 
in binaries. The goal of this thought experiment is to compare the occurrence 
inferred by observers ignoring binarity with the true occurrence in single 
star systems.

First, what are the possible apparent radii of detected planets?
If the true planet radius is $r=r\p$, then planets in singles will be 
detected with identical apparent radii: $r\a = r\p$.
Conversely, all detections in twin binaries will have apparent radii 
$r\a=r\p/\sqrt{2}$, because they are diluted.
For an unresolved point-source,
\begin{equation}
\delta_{\rm obs}
= \left(\frac{r\a}{R\a}\right)^2
= \left[{r\over R_{\rm host}}\right]^2\times {L_{\rm host} \over L_{\rm 
        sys}(M_1, q)},
\label{eq:delta_obs_general} 
\end{equation}
where $R_{\rm host}$ ($L_{\rm host}$) is the planet-host's stellar radius 
(luminosity), $R\a$ is the apparent stellar radius, $L_{\rm sys}=L_1+L_2 = 
L(M_1) + L(qM_1)$ is the system luminosity, and $q=M_2/M_1$ is the binary mass 
ratio.
We assume that the stellar radius and luminosity are uniquely related to the 
stellar mass.
The observers, with no a priori knowledge of the distance to a system, would 
measure a flux, and estimate a stellar mass $M\a=M_1$, a stellar 
radius $R\a = R(M\a)$, and an under-estimated system luminosity of $L_{\rm 
sys,a}(M\a) = L(M\a)$.

The planets will be detected if and only if their host stars are searchable.
For a fixed signal-to-noise floor, there is a maximum searchable 
distance~\citep{pepper_using_2003,pepper_searching_2005}.
From Eq.~\ref{eq:S_N_thresh}, this maximum searchable distance scales as
\begin{equation}
d(\delta_{\rm obs}, L_{\rm sys}) \propto \delta_{\rm obs} \cdot L_{\rm 
    sys}^{1/2}.
\end{equation}
Assuming that stars are uniformly distributed in space, the number 
of searchable stars $N\s$ is then proportional to
\begin{equation}
N\s(\delta_{\rm obs}, L_{\rm sys}) \propto n \delta_{\rm obs}^3 L_{\rm 
    sys}^{3/2},
\label{eq:N_searchable_prop}
\end{equation}
where $n$ is the number per unit volume of {\it e.g.}, single star, or binary 
systems.
We neglect the dependence of $n$ on stellar type.

The searchable volumes for our thought experiment are illustrated 
in Fig.~\ref{fig:model_1_volumes}.
At an apparent radius equal to the true radius ($r\a=r\p$), single stars 
with $d<d_0$ are searchable.
Binaries with $r\a=r\p$ are also searchable, out to $\sqrt{2}d_0$. 
However, in this model no such systems exist; all planets in twin binaries 
have true radii $r=r\p$, and so are observed with apparent radii 
$r\a=r\p/\sqrt{2}$, out to $d_0/\sqrt{2}$.
At an apparent radius of $r\a=r\p/\sqrt{2}$, there could also be planets with 
true radii $r=r\p/\sqrt{2}$ orbiting singles~---~however none of these exist 
in this model.

How many planets are detected?
If we assume that there are $N\s^0(r\a)$ singles that are searchable for 
planets with $r\a$, and that there are $Z_0$ planets per single, then 
single stars contribute
\begin{equation}
n_{\rm det}^0(r\a) = N\s^0(r\a) Z_0 p_{\rm tra} \cdot \delta(r\a - r_p)
\end{equation}
planet detections (per unit $r\a$), where $\delta$ is the Dirac delta function.

We can write similar equations for the binaries.
First though, we define a ratio $\mu \equiv N\s^{\rm b}(r\a) / N\s^0(r\a)$ 
between the number of searchable binary systems and the number of searchable 
singles at any $r\a$.
This quantity is useful because although $N\s^{\rm b}$ and $N\s^0$ vary
as a function of the observed transit depth, $\mu$ remains fixed.
Applying this definition, at $r\a=r\p/\sqrt{2}$, some detections will come 
from primaries,
\begin{equation}
n_{\rm det}^1(r\a) =
\mu N\s^0(r\a) Z_1 p_{\rm tra}
\cdot \delta\left(r\a - \frac{r\p}{\sqrt{2}}\right),
\end{equation}
and some from secondaries,
\begin{equation}
n_{\rm det}^2(r\a) = 
\mu N\s^0(r\a) Z_2 p_{\rm tra}
\cdot \delta\left(r\a - \frac{r\p}{\sqrt{2}}\right),
\end{equation}
where $Z_1$ is the number of planets per primary, $Z_2$ is the number of 
planets per secondary, and $p_{\rm tra}$ is the same for identical stars.
In the case of twin binaries, Eq.~\ref{eq:N_searchable_prop} gives $\mu = 
2^{3/2} n_{\rm b}/n_{\rm s} = 2^{3/2} {\rm BF}/(1-{\rm BF})$, for ${\rm BF}$ 
the binary fraction\footnote{The binary fraction is the fraction of systems in 
a volume-limited sample that are binary. It is equivalent to the multiplicity 
fraction if there are no triple, quadruple, or higher order multiples.
}.

The last item we need to write down the apparent rate density $\Gamma\a(r\a)$ 
is the number of unresolved point-sources on sky that the observer thinks are 
searchable, $N_{\rm s,a}$.
Assuming that the apparent stellar radius is fixed, then given the 
apparent planet radius $r\a$,
\begin{equation}
N_{\rm s,a}(r\a) = N\s^0(r\a) \times (1 + \mu)
\label{eq:apparentlysearchable_to_searchable}
\end{equation}
relates the number of apparently searchable point-sources to the number of 
searchable singles.
From the discussion above, it should be clear that there are in fact
$N\s^0(r\a)\times (1 + 2\mu)$ searchable stars at any given $r\a$; the 
observers are under-counting.

Using Eq.~\ref{eq:defn_apparent_rate_density}, the apparent rate density 
computed without considering binarity is
\begin{align}
\Gamma\a(r\a) = 
\frac{1}{1+\mu} Z_0 \cdot
\delta(r\a-r\p)  +
\frac{\mu}{1+\mu} (Z_1 + Z_2) \cdot
\delta\left(r\a-\frac{r\p}{\sqrt{2}} \right).
\label{eq:model_1_apparent_rate_density}
\end{align}
The number of searchable singles at a given apparent radius, 
$N\s^0(r\a)$, makes no appearance.
The observer's errors in Eq.~\ref{eq:model_1_apparent_rate_density} are 
(A) under-counting the number of searchable stars at any apparent radius;
and
(B) inferring radii in binary systems that are all $\sqrt{2}$ too small.

\begin{figure}[!tb]
    \begin{center}
        \includegraphics[width=.6\textwidth]{figures/occ_rate_vs_radius_model_1_brokenx.pdf}
    \end{center}
    \vspace{-0.5cm}
    \caption{
        Inferred occurrence rates over $0.01r_\oplus$ bins in planet 
        radius, for a model with identical stars, identical planets, and twin 
        binaries (same as Fig.~\ref{fig:model_1_volumes}).
        We assume a twin binary fraction of ${\rm BF}=0.1$, and that all 
        stars (single, primary, and secondary) host planets at equal 
        rates.
        If the true planet radius is $r\p$, all planets detected in binaries 
        will have apparent radii $r\a = r\p/\sqrt{2}$;
        Eq.~\ref{eq:model_1_apparent_rate_density} gives the normalizations.
        The rate and rate density are related by $\Lambda|_a^b = 
        \int_{a}^{b}\Gamma\,{\rm d}r$.
    }
    \label{fig:occ_rate_model_1}
\end{figure}

To assess the severity of these errors, we need to assume a binary fraction, 
and to know the true number of planets per single, primary, and secondary star 
($Z_0,Z_1,$ and $Z_2$).
For the former,
\citet{raghavan_survey_2010} found a multiplicity 
fraction of 0.44 for primaries with masses from $0.7M_\odot$ to $1.3M_\odot$, 
which we take as a binary fraction. 
``Twin binaries'' are perhaps 10-20\% of the binaries in a volume-limited 
sample, depending on how ``twin'' is defined.
Thus a representative twin binary fraction for this model is ${\rm BF}\approx 
0.05$-$0.1$. 
For the true number of planets per star, we take $Z_0=Z_1=Z_2=0.5$, and plot 
the resulting occurrence rates as a function of planet radius in 
Fig.~\ref{fig:occ_rate_model_1}.

Our point for comparison is the rate density for single stars,
\begin{equation}
\Gamma_0(r) = Z_0 \cdot \delta(r-r\p).
\end{equation}
We define a rate density ``correction factor'', $X_\Gamma$, as the ratio 
of the apparent to single star rate density,
\begin{equation}
X_\Gamma(r) \equiv \left. \frac{\Gamma_a(r\a)}{\Gamma_0(r)} \right|_{r\a 
    \rightarrow r}.
\end{equation}
Continuing in the assumption that the number of planets per single, primary, 
and secondary star are equal, then the rate density 
correction factor at the true planet radius is $1/(1+\mu)$.
This yields a correction of 0.76 if ${\rm BF}=0.1$, and 0.87 if ${\rm 
    BF}=0.05$. Rephrasing the result, if the twin binary fraction were 
$(2^{3/2}+1)^{-1}\approx 0.26$, then the apparent rate at $r\a=r\p$ would be 
half the true rate at $r=r\p$.
For most stellar types, the twin binary fraction is not that high.

An alternative assumption is that secondaries do not host planets. In that 
case, $Z_0=Z_1$, and $Z_2=0$. The correction to the rate density at the true 
planet radius becomes $(1+2\mu)/(1+\mu)^2$.
This evaluates to 0.94 if ${\rm BF}=0.1$, and 0.98 if ${\rm BF}=0.05$.
While it seems unlikely that secondaries are planet-less, 
the fact that $\Gamma\a/\Gamma$ is sensitive to the relative number 
of planets per single, primary, and secondary will become important as we 
proceed.

\subsection{Twin binaries, identical stars, two planet sizes}

A simple extension to the previous example will help us further distinguish 
the detected populations.
Consider now a universe that is the same in every respect to that of 
Sec.~\ref{sec:model_1}, except that half of planets have true radii $r\p$, 
while the other half have true radii $r\p/\sqrt{2}$.
The true rate densities are
\begin{equation}
\Gamma_i(r) = \frac{Z_i}{2} \left[
\delta(r-r\p) + \delta\left(r-\frac{r\p}{\sqrt{2}}\right)
\right], \quad {\rm for}\  i \in \{ 0,1,2 \},
\end{equation}
where as before $i=0$ corresponds to singles, $i=1$ to primaries, and $i=2$ to 
secondaries, and the $Z_i$'s are the number of planets per star of each type.

Following an identical line of reasoning as in Sec.~\ref{sec:model_1}, the 
apparent rate density can be written
\begin{align}
\notag
\Gamma\a(r\a) &=
\frac{1}{2(1+\mu)} \left[
Z_0 \cdot \delta(r\a - r\p)
+
\left[Z_0 + \mu (Z_1 + Z_2)
\right] \cdot \delta\left(r\a - \frac{r\p}{\sqrt{2}}\right) 
\right. \\
&\quad\quad\quad\quad\quad\quad\quad\quad+
\left.
\mu(Z_1 + Z_2) \cdot \delta\left(r\a - \frac{r\p}{2}\right)
\right].
\label{eq:two_radii_twins}
\end{align}
The important qualitative point of this equation is that at $r\a = 
r\p/\sqrt{2}$, two populations contribute.
The first population is singles with $r=r\p/\sqrt{2}$, and the second is twin 
binaries with $r=r\p$.
Both populations are detected out to the same maximum searchable distance.
Just as with Eq.~\ref{eq:apparentlysearchable_to_searchable}, we will have a 
cancellation of $N\s^0(r\a)$ terms, leaving only the $\mu$ weights.




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{General formula for apparent occurrence rate}
\label{sec:general_formula}

To generalize the procedure of Sec.~\ref{sec:simplest}, we consider an 
SNR-limited transit survey in which the singles and primaries can have 
arbitrary properties, but their true masses are known by the observer.
We assume that there are some functions $L(M)$ and $R(M)$ that specify a 
star's luminosity and radius in terms of its mass, and that the volume-limited 
binary mass ratio distribution, $f(q)$, is independent of the primary's mass.
We also allow arbitrary true rate densities for singles, primaries, 
and secondaries ($\Gamma_0, \Gamma_1, \Gamma_2$).
We presume that the observers always take the properties of a binary system to 
be those of the primary.

Given this laundry-list of assumptions, a general formula for the apparent 
rate density follows:
\begin{align}
\notag
\Gamma\a(r\a,M\a) &= {1\over 1+\mu(\mathrm{BF}, M\a)}\times
\left\{ \Gamma_0(r\a, M\a)+ 
\frac{{\rm BF}}{1 - {\rm BF}}
\left[ \int_0^1 \mathrm{d}q \,
       \frac{f(q)}{\mathcal{A}^3}\cdot
       \frac{1}{\mathcal{A}} \Gamma_1\left({r\a\over \mathcal{A}}, 
M\a\right)\,
\right.   
\right. \\
& \quad\quad\quad\quad\quad \left.\left.
+\int_0^1 {\rm d}q\, \frac{f(q)}{\mathcal{A}^3}\cdot \frac{q}{\mathcal{B}}
    \Gamma_2\left({r\a\over \mathcal{B}}, qM\a\right)\cdot
{R(qM\a) \over R(M\a)}
q^{-1/3} \right]	\right\},
\label{eq:general_Gamma_a}
\end{align}
where ${\rm BF}$ is the volume-limited binary fraction, 
and $\mathcal{A}(q,M\a)$ [$\mathcal{B}(q,M\a)$] are the dilution terms for 
primaries [secondaries], whose functional dependences are omitted for 
notational simplicity.
The dilution terms can be written
\begin{equation}
\mathcal{A}(q, M\a)=\sqrt{L(M\a) \over L_{\rm sys}(M\a, q)}
= (1+q^\alpha)^{-1/2},
\end{equation}
and
\begin{equation}
\mathcal{B}(q, M\a)={R(M\a)\over R(qM\a)}\sqrt{{L(qM\a) \over L_{\rm 
            sys}(M\a, q)} }
= q^{-1} (1+q^{-\alpha})^{-1/2}
\end{equation}
where the latter equalities assume $L\propto M^\alpha \propto R^\alpha$ (the 
former are more general).
The rate densities depend on both apparent radius and mass 
because even if the primaries and singles were to have fixed
mass, the mass of secondaries would vary, and so this dependence cannot be 
immediately omitted.


A derivation of Eq.~\ref{eq:general_Gamma_a} is given in the 
\hyperref[sec:appendix]{Appendix}; its qualitative features are as follows.
The terms inside the curly braces $\{ \ldots \}$ are the sum of 
the apparent rate densities from singles, primaries, and secondaries.
The contribution from singles is not affected by binarity.
In the contributions from primaries and secondaries,
planets with $(r\a, M\a)$ are associated with 
systems of different planetary and stellar properties, as determined
by the mass ratio $q$ of each binary.
This corresponds to true planet radii and stellar masses 
$(r\a/\mathcal{A},M\a)$ for primaries, and $(r\a/\mathcal{B},qM\a)$ for 
secondaries.
These contributions are then integrated over the mass ratio distribution 
including the effect of Malmquist bias, $f(q)/\mathcal{A}^3$, discussed 
further below. Finally, the latter term in the apparent rate density of 
secondaries comes from a correction for the overestimated transit probability.


\paragraph{Ratio of searchable binaries to singles}
We must also specify the exact form of $\mu({\rm BF},M\a)$, the ratio of 
the number of searchable binary systems to singles.
Given the observed signal $\delta_{\rm obs}$ and apparent stellar mass $M\a$, 
recall that the maximum searchable distance for singles and binaries are 
proportional to $\delta_{\rm obs}\cdot L(M\a)^{1/2}$ and $\delta_{\rm 
obs}\cdot [L(M\a)+L(qM\a)]^{1/2}$.
Applying Eq.~\ref{eq:N_searchable_prop},
\begin{equation}
\mu({\rm BF},M\a) = 
\frac{N\s^{\rm b}(r_a)}{N_s^0(r\a)}=
\int_0^1 {n_{\rm b}\over n_{\rm s}}\left[1+{L(qM\a) \over L(M\a)}\right]^{3/2} 
f(q)\,\mathrm{d}q.
\label{eq:mu_general}
\end{equation}
If $\mathrm{BF}$ is independent of $q$, $L \propto M^\alpha$, and $f(q) 
\propto q^\beta$, this simplifies to
\begin{equation}
\mu =\frac{{\rm BF}}{1 - {\rm BF}}\cdot {1\over{1+\beta}}\int_0^1 
\left(1+q^\alpha\right)^{3/2} q^\beta \,\mathrm{d}q,
\label{eq:mu_power_laws}
\end{equation}
which may be written in a closed form using the hypergeometric function.

\begin{figure}[!tb]
    \centering
    \includegraphics[width=0.6\textwidth]{figures/mass_ratio_distribution.pdf}
    \caption{
        The mass ratio distribution for a magnitude-limited sample of 
        binary stars, in which the underlying volume-limited distribution is 
        uniform, qualitatively similar to {\it e.g.}, 
        \citet{raghavan_survey_2010}'s Fig.~16.
        At a given observed transit depth, the searchable binaries in a 
        transit survey are magnitude-limited.
    }
    \label{fig:q_distribn_mag_limited}
\end{figure}

This can be understood as a Malmquist bias: at fixed observed transit 
depth, for singles and primaries with the same luminosity, binaries are 
searchable to a greater distance;
In particular, the sample of searchable binaries is magnitude-limited.
Given a searchable binary, the probability that it has a mass ratio $q$ 
scales as
\begin{equation}
p({\rm draw\ }q\,|\,{\rm system\ is\ binary}) \propto 
(1+q^\alpha)^{3/2} q^\beta 
\label{eq:Malmquist_bias}
\end{equation}
where $q^\beta$ is the volume-limited probability of drawing a binary of mass 
ratio $q$, and the first term is the Malmquist bias when $L\propto M^\alpha$.
We show this magnitude-limited mass ratio distribution for the $\beta=0$ case 
in Fig.~\ref{fig:q_distribn_mag_limited}.
In Monte Carlo simulations of transit surveys, it is 
important to draw binaries from a correctly biased mass-ratio distribution 
\citep[\textit{e.g.},][]{bakos_hatsouth:_2013,sullivan_transiting_2015,
    gunther_new_2017}.



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\input{results}

\section{More complicated transit survey models}
\label{sec:more_complicated}
The following section applies our general equation for the apparent rate 
density (Eq.~\ref{eq:general_Gamma_a}) to study binarity's effects in regimes 
of observational interest.
In general, we will write the rate density for each type of star, 
$\Gamma_i(r)$, as the product of a shape function and a constant:
\begin{equation}
\Gamma_i(r) = Z_i f_i(r), \quad {\rm for\ }i\in\{0,1,2\},
\end{equation}
where as always, $i=0$ corresponds to single stars, $i=1$ to primaries of 
binaries, and $i=2$ to secondaries of binaries.
The shape function is normalized to unity.
The $Z_i$'s are each system type's occurrence rate $\Lambda_i$, integrated 
over all planetary radii. In other words, they are number of planets per 
single, primary, or secondary star.
This section will consider the effects of varying both $f_i(r)$ and also the
relative values of the $Z_i$'s.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Power law planet radius distributions}
\label{sec:model_2}

\subsubsection{Twin binaries}
We begin introducing realism by keeping all binaries as twins, but letting the 
radius distribution of planets vary.
Specifically, we take
\begin{equation}
\Gamma_i(r) = Z_i f(r) = Z_i r^\delta/\mathcal{N}_r,
\end{equation}
for $f(r)$ the radius shape function, and $\mathcal{N}_r$ the shape function's 
normalization.
The resulting apparent rate density is quite similar to that of the twin 
binary, fixed-planet case (Eq.~\ref{eq:model_1_apparent_rate_density}), except 
for a slightly different radius dependence and normalization:
\begin{equation}
\Gamma\a(r\a) = \frac{r\a^\delta}{\mathcal{N}_r} \left[
\frac{Z_0}{1+\mu}
+
2^{\frac{\delta+1}{2} } \frac{\mu}{1+\mu} \left(Z_1 + Z_2
\right)
\right].
\label{eq:model5_apparent_rate_density}
\end{equation}
As in Sec.~\ref{sec:model_1}, $\mu = 2^{3/2} {\rm BF}/(1-{\rm BF})$.
If the $Z_i$'s are equal, the ``correction factor'' relative to the rate 
density for singles becomes quite simple:
\begin{align}
\left. \frac{\Gamma\a(r\a)}{\Gamma_0(r)} 
\right|_{r\a\rightarrow r}
&=
\frac{1 + 2^{\frac{\delta+3}{2}}\mu}{1 + \mu}.
\label{eq:power_law_correction}
\end{align}
For the case of ${\rm BF}=0.1$, $\mu\approx 0.153$. Taking $\delta=-2.92$ from 
\citet{howard_planet_2012},  we get a correction factor $\Gamma\a/\Gamma_0 = 
1.004$.
In other words, the apparent rate density is an {\it over}estimate compared to 
the rate density of single stars, with a relative difference $\delta \Gamma_0 
= |\Gamma_0 - \Gamma\a | / \Gamma_0$ of 0.4\%.
This is quite a small effect!
Note though that it could change if the $Z_i$'s are not equal.
Also, the power law radius distribution $f(r) \propto r^\delta$ diverges for 
$\delta < 0$; \citet{howard_planet_2012}'s results indicate that this
approximation is good for $r\a\gtrsim 2r_\oplus$.
Similarly, it is nonsensical for $f(r)$ to be finite above some upper radius 
limit $r_u$, perhaps around $\approx 24r_\oplus$, based on the most inflated 
hot Jupiters.
An upper cut-off of $r_u$ would lead to smaller values of $\Gamma(r\a)$ 
down to $r_u/\sqrt{2}$, compared to an intrinsic power law without the cut-off.
We are not particularly interested in this effect; there are better 
models for hot Jupiter occurrence rates that we will discuss in 
Sec.~\ref{sec:further_models}.
If the assumptions behind this model (listed in 
Sec.~\ref{sec:general_formula}) are at all applicable in real transit surveys, 
this suggests that for $2r_\oplus \lesssim r\a \lesssim 17r_\oplus$, 
binarity's impact on derived occurrence rates is quite small.



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Varying binaries}
\label{sub:powerlaw_varying_binaries}

To check whether non-twin binaries change the preceding result, we now assume 
$f(q) = q^\beta/\mathcal{N}_q$, for $\mathcal{N}_q$ the normalization.
This changes $\mu$ (Eq.~\ref{eq:mu_general} simplifies to 
Eq.~\ref{eq:mu_power_laws}).
It may also affect the rate density, which could be a function of the 
(varying) stellar mass.
Absorbing this dependence into a power law as well,
\begin{equation}
\Gamma_i(r,M) = Z_i \times \frac{r^\delta}{\mathcal{N}_r} \times
\frac{M^\gamma}{\mathcal{N}_M},
\end{equation}
where $Z_i$ is dimensionless, and the normalization constants carry 
the units (each side has units $[r^{-1} M^{-1}]$).
We assume that stars are a one-parameter family, given by $R \propto M \propto 
L^{\frac{1}{\alpha}}$, so that a given value of $q$ determines everything 
about a secondary.

We are mostly interested in the apparent rate density's radius dependence.
Marginalizing Eq.~\ref{eq:general_Gamma_a} over apparent stellar mass, we find
that when $Z_0=Z_1=Z_2$,
\begin{align}
X_\Gamma &\equiv \left. \frac{\Gamma\a(r\a)}{\Gamma_0(r)} 
\right|_{r\a\rightarrow r} \\
&=
\notag
\frac{1}{1+\mu}
\left[1 + \frac{1}{\mathcal{N}_q} \frac{{\rm BF}}{1-{\rm BF}}\times 
\left(
\int_0^1 {\rm d}q\,q^\beta (1+q^\alpha)^{\frac{\delta+4}{2}} +
\right.
\right. \\
&\quad\quad\quad\quad\quad\quad\quad\quad\quad\quad
\left.\left.
\int_0^1 {\rm d}q\,q^{\beta+\delta+\frac{5}{3}} 
(1+q^\alpha)^{\frac{3}{2}}
(1+q^{-\alpha})^{\frac{\delta+1}{2}}
\right)\right],
\label{eq:powerlaw_vary_binary}
\end{align}
where $\gamma$ does not appear because of the marginalization over $M\a$.
For $\alpha = 3.5$, $\beta=0$, $\gamma=0$, $\delta=-2.92$, the 
summed integrals in Eq.~\ref{eq:powerlaw_vary_binary} give $(\ldots)\approx 
1.50249$. %171211_model_integrals.nb
For ${\rm BF}=0.44$, this yields $\Gamma\a/\Gamma_0 = 1.048$; the
relative difference between the apparent rate density and the rate density 
around singles is 4.8\%.
This indicates that considering only twin binaries gave us correct 
intuition: for a power-law radius distribution 
($2r_\oplus \lesssim r\a \lesssim 17r_\oplus$) in which there are the same 
number of planets orbiting singles, primaries, and secondaries, binarity 
influences apparent planet occurrence rates around Sun-like stars at the 
$\sim$few percent level.




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Fixed primaries, varying secondaries, broken power-law planets}
\label{sec:model_3}

\begin{figure}[!t]
    \centering
    \epsscale{1.15}
    \plottwo{figures/int_rate_density_vs_radius_model_3_rpu_22.5_manyZs.pdf}{figures/int_occ_rate_vs_radius_model_3_rpu_22.5_manyZs.pdf}
    \caption{
        {\it Left:} rate density and {\it right:} rate (over $0.5r_\oplus$ 
        bins) as a function of planet radius for the distribution specified by 
        Eq.~\ref{eq:model3_radius_distribution}. 
        This model assumes that the true properties of all the singles and 
        primaries are known to the observer, and that the volume-limited mass 
        ratios of secondaries are drawn from a uniform distribution. We use an 
        arbitrary normalization of $Z_0=Z_1=0.5$ throughout.
        The rate and rate density are related by $\Lambda|_a^b 
        = \int_{a}^{b}\Gamma\,{\rm d}r$.
    }
    \label{fig:occ_rate_model_3_log}
\end{figure}

Though the details of the true radius distribution $\Gamma_i(r)$ at 
$r<2r_\oplus$ are currently an active topic of research, we can consider how 
binarity affects this regime under various reasonable assumptions.
For instance, assume that the true radius shape function is
\begin{align}
f(r)
&\propto
\left.
\begin{cases}
r^\delta & \text{for } r\geq 2r_\oplus \\
{\rm constant} & \text{for } r\leq2r_\oplus.
\end{cases}
\right.
\label{eq:model3_radius_distribution}
\end{align}
As in the previous model, we assume that the observers know the true 
properties of all singles and primaries. The masses, radii, 
and luminosities of stars vary as $R \propto M \propto L^{\frac{1}{\alpha}}$.
Our ``nominal model'' remains the same: 
$\alpha=3.5$, $\beta=\gamma=0$, $\delta=-2.92$.

At apparent radii $r\a > 2r_\oplus$, the results of this model are the same as 
those from Sec.~\ref{sub:powerlaw_varying_binaries}.
For $r\a < 2r_\oplus$, the equations are tedious, but still tractable.
For simplicity, we insert Eq.~\ref{eq:model3_radius_distribution} into 
Eq.~\ref{eq:general_Gamma_a}, and integrate using a computer 
program. We refer the interested reader to our online 
implementation\footnote{\url{https://github.com/lgbouma/binary_biases}}.
The output is validated against analytic predictions in the $r\a > 
2r_\oplus$ and the $r\a < 2r_\oplus/\sqrt{2}$ regimes, and is plotted in
Fig.~\ref{fig:occ_rate_model_3_log}.


\paragraph{The rate of Earth analogs}
The immediately arresting result there is a ``bump'' in the apparent rate 
density at $r\a < 2r_\oplus$: the true rate for singles is less than the 
inferred rate.
For the case in which secondaries host as many (half as many) planets as 
single stars, this means an overestimate of the absolute occurrence rate by 
$\approx 50\%$ ($\approx 25\%$).
The ``bump'' exists even for the $Z_2/Z_0=0$ case as a $\approx 10\%$ effect.
Evidently, the magnitude of this error depends strongly on the prevalence of 
planets around secondaries.

\paragraph{Hot Jupiter occurrence rates}
Taking Fig.~\ref{fig:occ_rate_model_3_log} and integrating the rate density, 
we can compare the apparent hot Jupiter 
occurrence rate with the true rate for singles.
In the most extreme case of $Z_2/Z_0=0$, we find that $\Lambda_{{\rm 
HJ},0}/\Lambda_{\rm HJ,a} = 1.13$, where
\begin{equation}
\Lambda_{\rm HJ,a} = \int_{8r_\oplus}^{\infty} \Gamma\a(r)\,{\rm d}r,
\end{equation}
and similarly for $\Lambda_{\rm HJ,0}$.
%occ_rate_vs_radius_model_3_withtext_Zsub2_0.00_rpu_22.5.pdf
If $Z_2/Z_0>0$, binarity affects the apparent hot Jupiter rate less: when 
$Z_2/Z_0=0.5$, we find $\Lambda_{{\rm HJ},0}/\Lambda_{\rm HJ,a} = 1.06$.

\paragraph{Fraction of detected planets from a given source}

\begin{figure}[!t]
    \centering
    \includegraphics[width=\textwidth]{figures/ndet_vs_radius_logx_model_3_fraclines_rpu_22.5_manyZs.pdf}
    \caption{
        Fraction of detected planet at a given apparent planet radius coming 
        from singles (solid lines), primaries (dashed lines), and secondaries 
        (dotted lines).
        Three different values for $Z_2/Z_0$ are selected: $1$ (blue), $0.5$ 
        (orange), $0$ (green).
        The assumed true planet radius distribution is a broken power-law
        (Eq.~\ref{eq:model3_radius_distribution}; same as 
        Fig.~\ref{fig:occ_rate_model_3_log}).
    }
    \label{fig:frac_model_3}
\end{figure}

It would be nice to improve our intuition for how much the secondaries matter.
We have the understanding that for a given true planet radius, secondaries 
have a much smaller searchable volume than primaries or singles.
Does this necessarily imply that if we are given a detected planet with some 
apparent radius $r\a$, which is then observed by high-resolution imaging to 
exist in a binary, that the planet probably orbits the primary?

We explore this quantitatively in Fig.~\ref{fig:frac_model_3}.
The lines in this figure are computed using the expressions given in the 
appendix for the number of detections coming from singles, primaries, and 
secondaries (Eqs.~\ref{eq:n_det_0},~\ref{eq:n_det_1}, and~\ref{eq:n_det_2}).

In short, the detected planet usually is more likely to orbit the primary, but 
it depends on the number of planets orbiting secondaries, and also on the 
apparent radius of the detected planet.
In the scenario that high-resolution imaging finds a system with $r\a > 
2r_\oplus$ in a binary, roughly $\sim\! 2.5\times$ more detected planets orbit 
primaries than secondaries, for the $Z_2/Z_0=1$ case.
For the $Z_2/Z_0=0.5$ case, $\sim\! 5\times$ more detected 
planets orbit primaries than secondaries.
So detected planets in binaries with large apparent radii (relative to the 
cutoff in the intrinsic rate density) are more likely to orbit the primary.

The situation for $r\a < 2r_\oplus$ is more nuanced.
For the $Z_2=0$ and $Z_2/Z_0=0.5$ cases, detected planets in binaries are 
still always more likely to orbit the primary.
However, if there are as many planets orbiting the secondaries as the 
primaries, then there is a turn-over radius, $\approx 0.4r_\oplus$, 
beyond which more of the detected planets in binaries come from secondaries: 
they have all been ``diluted down'' from larger true planetary radii!
Although this (apparent) radius is at the limit of current detection 
sensitivities, this effect will be interesting for future instruments to 
investigate.

Further, Fig.~\ref{fig:frac_model_3} shows that going from apparent 
radii of $2r_\oplus$ to $\approx 1.4r_\oplus$, the fraction of detected 
planets with binary companions increases by $\approx 6-12\%$, depending on the 
assumed value of $Z_2/Z_0$.
Let the fraction of total detected planets from primaries at a given 
apparent radius be $F_1(r\a)$, so $F_1(r\a) \equiv n_{\rm det}^1(r\a)/n_{\rm 
det}^{\rm tot}$.
Let the analogous quantity for secondaries be $F_2(r\a)$.
In the planet-less secondaries case ($F_2(r\a)=0$), one can 
analyze Eqs~\ref{eq:n_det_0} and~\ref{eq:n_det_1} semi-analytically and show 
that $F_1(2r_\oplus/\sqrt{2})/F_1(2r_\oplus) \approx 1.19$.
%check_companion_fractions.py, and LB's notes 2017/12/21.0
Intuitively speaking, this ``shift'' is a feature of any radius distribution 
that declines at large radii, and flattens below some cutoff $r_{\rm c}$.
This is because (for dilution about primaries)
at apparent radii $r\a < r_{\rm c}/\sqrt{2}$, relatively more planets will be 
``diluted'' into the given $r\a$, since there are more planets in 
the undiluted distribution from $r\a$ to $\sqrt{2}r\a$.
This prediction is compared against current measurements in 
Sec.~\ref{sec:discussion}.



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Further models: radius gaps, Gaussian HJ distributions}
\label{sec:further_models}

The radius distribution specified by Eq.~\ref{eq:model3_radius_distribution} 
misses some important features recently reported by state of the art 
occurrence rate studies.

\paragraph{Precise features of the radius valley}

\begin{figure}[!t]
    \centering
    \epsscale{1.15}
    \plottwo{figures/int_rate_density_vs_radius_model_4_xcut_manyZs.pdf}{figures/int_occ_rate_vs_radius_model_4_xcut_manyZs.pdf}
    \caption{
        {\it Left:} rate density and {\it right:} rate (over $0.25r_\oplus$ 
        bins) as a function of planet radius in a model with a radius gap 
        (Eq.~\ref{eq:model4_radius_distribution}).
        Other than the intrinsic radius distribution, this model has the same 
        assumptions as Fig.~\protect\ref{fig:occ_rate_model_3_log}.
    }
    \label{fig:model_4}
\end{figure}

In particular,~\citet{fulton_california-_2017} reported a ``gap'' in 
the radius-period 
plane~\citep{petigura_california-kepler_2017,johnson_california-kepler_2017}.
The existence of the gap has been independently corroborated from a sample of 
KOIs with asteroseismically-determined stellar 
parameters~\citep{van_eylen_asteroseismic_2017}.
Precise measurement of the gap's features, in particular its width, 
depth, and shape, will require accurate occurrence rates.
To illustrate binarity's role in this problem, we make identical assumptions 
as in Sec.~\ref{sec:model_3}, but instead assume an intrinsic radius 
distribution
\begin{align}
f(r)
&\propto
\left.
\begin{cases}
r^\delta & \text{for } r\geq 2r_\oplus, \\
0 & \text{for } 1.5r_\oplus < r < 2r_\oplus, \\
{\rm constant} & \text{for } r\leq1.5r_\oplus.
\end{cases}
\right.
\label{eq:model4_radius_distribution}
\end{align}
The resulting true and inferred rates are shown in Fig.~\ref{fig:model_4}.
If left uncorrected, binarity makes the gap appear more shallow, and flattens 
the step-function edges.
Of course, other effects could also ``blur'' the gap in the planet radius 
dimension. 
In particular, the valley's period-dependence is almost certainly not flat
\citep{van_eylen_asteroseismic_2017,owen_evaporation_2017}.
This means that any study measuring the gap's width or depth in the face of 
binarity must either perform tests at fixed orbital period, or else 
marginalize over period and account for the associated blurring in the planet 
radius dimension.


\paragraph{Alternative models for the HJ distribution}

In the recent work by~\citet{petigura_CKS_2017}, hot Jupiters appear as an 
island in period-radius space, rather than as a continuous component of a 
power law distribution.
This means that the apparent HJ rates computed in 
Sec.~\ref{sec:model_3} are probably inaccurate.
Instead, let us consider a Gaussian radius shape function,
\begin{equation}
f(r) \propto \exp \left( -\frac{(r-\bar{r})^2}{2\sigma^2} \right),
\end{equation}
with $\bar{r} = 14r_\oplus$ and $\sigma = 2r_\oplus$.
As always, $\Gamma_i(r) = Z_i f(r)$.
We then compute $\Gamma\a(r\a)$, and plot it in Fig.~\ref{fig:gaussian_HJ}.
Integrating for $r\a > 8r_\oplus$ to find hot Jupiter rates,
we find the opposite effect as in the power law model.
For $Z_2/Z_0>0$, 
the apparent HJ rate is {\it greater} than the true rate for singles.
The effect is maximal when there are as many hot Jupiters orbiting secondaries 
as singles, in which case
$\Lambda_{{\rm HJ},0}/\Lambda_{\rm HJ,a} = 0.81$.
%int_rate_density_vs_radius_model_7_withtext*manyZs.pdf
For the case when no hot Jupiters orbit secondaries, $\Lambda_{{\rm HJ},0} 
\approx \Lambda_{\rm HJ,a}$ to within one percent.
Qualitatively, the apparent HJ rate can be greater than the true rate for 
singles because binary systems can have an extra star that yields 
hot Jupiter detections.


\begin{figure}[!tb]
    \centering
    \includegraphics[width=.6\textwidth]{figures/int_rate_density_vs_radius_model_7_rpu_22.5_manyZs.pdf}
    \caption{
        Rate density for a population of planets with true radii $r$ drawn from
        $\mathcal{N}(14r_\oplus,2r_\oplus)$.
        This is similar to the hot Jupiter distribution presented 
        by~\citet{petigura_CKS_2017}.
    }
    \label{fig:gaussian_HJ}
\end{figure}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\input{discussion}

\section{Discussion}
\label{sec:discussion}


\paragraph{How bad is ignoring binarity?}
This study has shown that under a reasonable set of simplifying assumptions, 
ignoring binarity introduces systematic errors to star and planet counts in 
transit surveys, which then biases derived occurrence rates.
Thus far, occurrence rate calculations\footnote{
    A list of occurrence rate papers is maintained at 
    \url{https://exoplanetarchive.ipac.caltech.edu/docs/occurrence_rate_papers.html}
} using transit survey data have mostly ignored stellar 
multiplicity~\citep[\textit{e.g.},][]{howard_planet_2012,fressin_false_2013,foreman-mackey_exoplanet_2014,dressing_occurrence_2015,burke_terrestrial_2015}.
For {\it Kepler} occurrence rates specifically, 
it seems that no one has yet carefully assessed binarity's importance, or lack 
thereof.
Although this study does not resolve the problem, it does suggest the 
approximate scale of the possible errors, in a survey-independent manner.
The suggestion of Sec.~\ref{sec:model_2} is that for $r\a \gtrsim 2r_\oplus$, 
binarity can be ignored down to the $\sim$few percent precision level.
For apparent radii $\lesssim 2r_\oplus$, the picture is less forgiving:
Sec.~\ref{sec:model_3} suggests that relative errors between apparent rates 
and true rates around singles could easily reach $\sim\! 50\%$.

\paragraph{The rate of Earth analogs}
In line with {\it Kepler}'s primary science goal, the rate of Earth-like 
planets orbiting Sun-like stars has been independently measured by 
\citet{youdin_exoplanet_2011,petigura_prevalence_2013,dong_fast_2013,
    foreman-mackey_exoplanet_2014}, and \citet{burke_terrestrial_2015}.
These efforts revealed that the one-year terrestrial planet occurrence rate 
is between $\approx\! 0.03$ and $\approx\!1$ per Sun-like star,
depending on assumptions that are made when calculating the rate 
(\citealt{burke_terrestrial_2015}'s Fig.~17).
In Sec.~\ref{sec:model_3}, our power law model indicates that when primaries, 
singles, and secondaries host the same number of planets, the apparent rate is 
50\% higher than the true rate around single stars.
Though this bias seems large, it is currently smaller than the other 
systematic factors that dominate the dispersion in $\eta_\oplus$ 
measurements.
If future analyses determine absolute values of $\eta_\oplus$ to 
better than a factor of two, binarity will likely merit closer attention.

One caveat to this assessment of binarity's importance for 
$\eta_\oplus$ measurements is that none of our models 
included the rate density's period-dependence. However, close binaries usually
provoke dynamical instabilities, leading to fewer long-period planets per 
star~\citep[\textit{e.g.},][]{holman_long-term_1999,wang_influence_2014,
    kraus_impact_2016}.
This might affect transit survey measurements of $\eta_\oplus$ beyond our 
rough estimate.

\paragraph{Hot Jupiter rate discrepancy}
While binarity may appreciably affect $\eta_\oplus$ measurements, our analysis
suggests that it is unlikely to influence the hot Jupiter rate discrepancy.
The context of this disagreement is that hot Jupiter occurrence rates measured 
by transit surveys ($\approx 0.5\%$) are marginally lower than those found by 
radial velocity surveys ($\approx 1\%$; see Table~\ref{tab:hj_rates}).
Though the discrepancy has weak statistical significance ($<3\sigma$),
one reason to expect a difference is that the corresponding stellar 
populations have distinct metallicities.
As argued by \citet{gould_frequency_2006}, the RV sample is biased towards 
metal-rich stars, which have been measured by RV surveys to preferentially 
host more giant 
planets~\citep{santos_spectroscopic_2004,fischer_planet-metallicity_2005}.
Investigating the discrepancy from the metallicty 
angle,~\citet{guo_metallicity_2017} measured the
{\it Kepler} field's mean metallicity to be $[{\rm M/H}]_{\rm Kepler}= 
-0.045\pm0.009$, which is lower than the California Planet Search's mean of 
$[{\rm M/H}]_{\rm CPS}= -0.005\pm0.006$.
The former value agrees with that measured by \citet{dong_metallicities_2014}.
Refitting for the metallicity exponent in $\Lambda_{\rm HJ} \propto 10^{\beta 
    [{\rm M/H}] }$, \citeauthor{guo_metallicity_2017}\! found $\beta = 2.1\pm 
0.7$, and noted that this would imply that the metallicity difference could 
account for a $\approx 20\%$ relative difference in the measured rates between 
the CKS and {\it Kepler}\ samples~--~not a factor of two\footnote{
    \citet{petigura_CKS_2017} recently found $\beta = 3.4^{0.9}_{-0.8}$.
    This gives a $\approx 25\%$ relative difference, indicating metallicity 
    could 
    account for about half of the ``hot Jupiter rate discrepancy''.
}.
\citeauthor{guo_metallicity_2017}\! concluded that ``other factors, such as 
binary contamination and imperfect stellar properties'' must also be at play.

The hypothesis that binarity might matter is grounded in the fact that radial 
velocity and transit surveys treat binarity differently.
Radial velocity surveys typically reject both visual and spectroscopic binaries
\citep[\textit{e.g.},][]{wright_frequency_2012}.
Transit surveys observe binaries, but the question of whether they 
were searchable to begin with is left for later interpretation.
In spectroscopic follow-up of transiting planet candidates, the prevalence of 
astrophysical false-positives may also lead to a tendency against confirming 
transiting planets in binary systems.
A separate observational bias is that the RV surveys typically observe 
chromospherically ``quiet'' stars, which may bias their detection probability 
high~\citep{bastien_radial_2014}.

Ignoring these complications, in this work we concentrated on binarity's 
effects on star counts and the apparent radii of detected planets.
Assuming a power-law radius distribution, and that no secondaries host HJs,
our results from Sec.~\ref{sec:model_3} indicate that binarity 
could lead to underestimated HJ rates relative to singles by a multiplicative 
factor of at most $\approx 1.13$.
We later pointed out in Sec.~\ref{sec:further_models} that assuming a 
power-law radius distribution is probably wrong if one wishes to study the HJ 
rate discrepancy.
If we instead assumed a Gaussian radius 
distribution~\citep[following][]{petigura_CKS_2017}, apparent 
HJ rates are {\it greater} than the true rate around singles: the effect goes 
the wrong way.
\begin{comment}
If we believe the assumed power-law radius distribution, we can ask whether 
this ``correction factor'' might help resolve the discrepancy.
Explicitly, we ask: what is the probability of \citet{wright_frequency_2012}'s 
result, given a rate drawn from the stated bounds of~\citet{petigura_CKS_2017}?
In other words, we first take the true HJ rate per thousand stars as 
$\Lambda_{\rm HJ} = 5.7 \pm 1.3$, with Gaussian uncertainties. 
We then draw from a Poisson distribution and compute the probability of 
detecting at least 10 hot Jupiters in a sample of 836 stars.
Without accounting for binarity or metallicity, only 4\% of RV surveys would 
detect at least 10 hot Jupiters.
If we multiply $\Lambda_{\rm HJ}$ by $1.2$ to account 
for~\citet{guo_metallicity_2017}'s measured metallicity difference between the 
{\it Kepler}\ field and the local solar neighborhood, 9\% of RV surveys would 
detect at least 10 hot Jupiters.
If we multiply once more by $1.13$ to account for binarity's supposed bias, we 
find that 14\% of RV surveys would detect at least 10 hot Jupiters, still 
suggesting a weak discrepancy.

This suggestion should be taken with caution, because it (likely incorrectly) 
assumes a power-law radius distribution.
\end{comment}
The ``hot Jupiter island'' reported by~\citet{petigura_CKS_2017} cannot 
possibly be part of a continuous power law. 
Thus binarity is unlikely to resolve the HJ rate discrepancy.

Of course, such calculations are only suggestive; a conclusive resolution 
of binarity's effects may require a detailed understanding of the 
{\it Kepler}\ field's multiplicity statistics, and the mission's completeness 
(both for candidate detection and follow-up).
For instance, if hot Jupiters are less likely to be confirmed in binary 
systems, this might bias the rates low.
Alternatively, {\it TESS}\ is expected to discover over $10^4$ 
giant planets~\citep{ricker_transiting_2014,sullivan_transiting_2015}.
Though they will be difficult to distinguish from false positives, one 
possible use of this sample will be to measure an occurrence rate of 
short-period giant planets with minimal error from counting statistics.
Our models suggest that binarity will only become an appreciable fraction of 
the error budget at the $\approx 10\%$ precision level.
This should be sufficient for a rate measurement precise enough to indicate a 
preference between $\approx 0.5\%$ and $\approx 1\%$ of Sun-like stars hosting 
hot Jupiters.



\paragraph{Practical effects: smooth detection efficiencies; finite SNR floors}
To relate this study's results to {\it Kepler}\ and other transit surveys, a 
few practical concerns become pressing.

First, our calculations have ignored the fact that any given transit survey's 
finite SNR floor might censor the apparent rate density.
If the surveyed stars all have the same size, this is equivalent to 
saying that there might be a cutoff in apparent planet radii, below which no 
planets are detected.
The effects on our main results (e.g., 
Figs.~\ref{fig:occ_rate_model_3_log},~\ref{fig:frac_model_3}, 
and~\ref{fig:gaussian_HJ}) would be that the apparent rate density 
below the cutoff in apparent radius would simply drop to zero.

A second assumption we used is that the detection efficiency is a 
step function in SNR.
The detection efficiencies of real transit survey pipelines are smooth 
functions in SNR; see for example the injection \& recovery simulations 
performed by~\citet{christiansen_measuring_2016} on {\it Kepler}\ data, 
and the resulting smooth functional form adopted 
by~\citet{fulton_california-_2017}.
If we were to take a smooth detection probability in SNR, we would need to 
include a detection efficiency term in 
Eq.~\ref{eq:defn_apparent_rate_density} to inversely weight for planets 
with low probabilities of being detected.

The simplest way to avoid the conceptual complications of accounting for 
finite detection efficiency is to raise the SNR floor, to {\it e.g.,} 
${\rm SNR} \approx 12$ for {\it Kepler} 
(\citealt{fulton_california-_2017}, Fig.~5).
To a good approximation, this allows one to use the boolean distinctions 
``searchable'' and ``not searchable'' for signals of an observed depth (at 
fixed orbital period).
This also makes the survey strictly SNR-limited, rather than ``fuzzily 
SNR-limited''.
Since this threshold is set in an arbitrary manner anyway\footnote{For 
    example, {\it Kepler}'s threshold of ${\rm SNR}=7.1$ was set for there to 
    be 
    no more than one statistical false alarm across the full {\it Kepler} 
    campaign~\citep{jenkins_tests_2002}. Equally valid would have been to 
    insist 
    on no more than $10^{-3}$ false alarms per survey, raising the detection 
    floor.
}, this simplification would put occurrence rate studies on 
clearer conceptual 
ground, and facilitate the process of converting the observed distributions
of apparent radii into true radius distributions.

\begin{comment}
If one insists on using a smooth detection efficiency, then life probably 
becomes more complicated.
It might then be necessary to model the detection pipeline's efficiency while 
somehow marginalizing over binarity.
Since the relative number of detections (at fixed $\delta_{\rm obs}$) coming 
from singles, primaries, and secondaries changes as a function of the 
intrinsic distribution of planet parameters (Fig.~\ref{fig:frac_model_3}), 
some complicated deconvolution might be required.
\end{comment}





\paragraph{Connecting high resolution imaging to occurrence rates}
A direct reason to address stellar multiplicity in transit surveys is that it 
changes the interpretation of planet candidates on a system-by-system level.
Consequently, high resolution imaging 
campaigns have measured the multiplicities of almost all {\it Kepler}\ Objects 
of Interest 
\citep{howell_speckle_2011,adams_adaptive_2012,adams_adaptive_2013,horch_observations_2012,
    horch_most_2014,lillo-box_multiplicity_2012,lillo-box_high-resolution_2014,dressing_adaptive_2014,
    law_robotic_2014,cartier_revision_2015,everett_high-resolution_2015,gilliland_hubble_2015,
    wang_influence_2015,wang_influence_2015-1,baranec_robo-ao_2016,ziegler_robo-ao_2017}.
The results of these programs have been collected 
by~\citet{furlan_kepler_2017}, and they represent an important advance in 
understanding the KOI 
sample's multiplicity statistics.
In particular, they can be immediately applied to rectify binarity's effects 
on the mass-radius diagram~\citep{furlan_densities_2017}.

These high resolution imaging campaigns are also beginning to connect with
occurrence rate calculations.
The most recent rate studies have used~\citet{furlan_kepler_2017}'s 
catalog to test the effects of removing KOI hosts with known companions, which 
helps reduce contamination in the ``numerator'' of 
the occurrence rate (\citealt{fulton_california-_2017}; 
\citealt{petigura_CKS_2017}).
However, without an understanding of the multiplicity statistics of the 
non-KOI stars, the true number of searchable stars, and thus the true 
occurrence rates, will remain biased.

\paragraph{Does a detected planet orbit the primary or secondary?}
One important step towards rectifying binarity's effects is identifying the 
host star for any detected planets in binaries.
The current 
wisdom is that nothing substantive can be said about the 
likelihood of a planet orbiting the primary vs. the 
secondary~\citep[\textit{e.g.},][]{ciardi_understanding_2015,ziegler_robo-ao_2017}.
This of course ignores cases when planets can be confirmed to orbit either 
component by analyzing the transit durations or centroids.

\begin{comment}
\citet{ciardi_understanding_2015} studied the effects of stellar multiplicity 
on the planet radii derived from transit surveys.
They modeled the problem for {\it Kepler}\ objects of interest by matching a 
population of binary and tertiary companions to KOI stars, 
under the assumption that the KIC-listed stars were the primaries.
They then computed planet radius correction factors assuming that {\it 
    Kepler}-detected planets orbited the primary or companion stars
with equal probability (their Sec.~5).
Under these assumptions, they found that any given planet's radius is on 
average underestimated by a multiplicative factor of $\approx\! 1.5$.
\citet{ziegler_robo-ao_2017} recently reported a similar mean radius 
correction factor for the multiple systems observed by the Robo-AO KOI survey, 
using the same assumption that detected planets are as likely to orbit the 
primary and the secondary.
\end{comment}

Assuming a broken power-law radius distribution, we showed in 
Fig.~\ref{fig:frac_model_3} that there are many cases where a detected planet 
is much more likely to orbit the primary.
A planet orbiting the secondary does lead to extreme corrections.
However, at $r\a \gtrsim 2r_\oplus$, these cases are rare outliers.
At $r_\oplus \lesssim r\a \lesssim 2r_\oplus$, for all of the trial values of 
$Z_2/Z_0$ assumed in Fig.~\ref{fig:frac_model_3}, a detected planet is always 
more likely to orbit the primary than the secondary.
Only at very small apparent radii, $r\a \approx 0.5r_\oplus$, and only if 
secondaries host as many planets as singles and primaries, does this ``rule'' 
break down.

Of course, our model's assumptions (see the list in Sec.~\ref{sec:conclusion}) 
might not apply to the {\it Kepler}\ dataset.
However if they are applicable, then for the $56\%$ of ``\texttt{CONFIRMED}'' 
KOIs\footnote{Exoplanet Archive; \cite{akeson_nasa_2013}; 
    \url{exoplanetarchive.ipac.caltech.edu}} with 
apparent radii $>2r_\oplus$, 
whenever high-resolution imaging 
discovers a binary companion in 
a system that hosts a detected transiting planet, the planet is much
more likely to orbit the primary.


\paragraph{Fraction of detected planets with binary companions vs. apparent 
radius}
One further prediction of Fig.~\ref{fig:frac_model_3} is that the fraction of 
detected planets with binary companions increases by $\approx 6-12\%$ going 
from $2r_\oplus$ to $\approx\! 1.4r_\oplus$.
In \citet{ziegler_robo-ao_2017}'s recent summary of the Robo-AO KOI survey, 
they reported the fraction of planet-hosting stars with Robo-AO detected 
companion stars, binning by Earths ($r\a < 1.6r_\oplus$), Neptunes 
($1.6r_\oplus < r\a < 3.9 r_\oplus$), Saturns ($3.9r_\oplus < r\a < 9 
r_\oplus$), and Jupiters ($r\a > 9r_\oplus$).
The reported nearby star rates and their $1\sigma$ uncertainties are:
\begin{itemize}
    \item Earths: $16.3 \pm 1.0\%$, from 1480 systems.
    \item Neptunes: $13.0 \pm 0.8\%$, from 2058 systems.
    \item Saturns: $13.6 \pm 2.0\%$, from 338 systems.
    \item Jupiters: $19.0 \pm 2.8\%$, from 247 systems.
\end{itemize} 
where the uncertainties were calculated 
following~\citet{burgasser_binarity_2003}.
The absolute values of the rates are less than the $\sim\! 45\%$ typical for 
Sun-like stars at least in part because of Robo-AO's sensitivity 
(\citealt{ziegler_robo-ao_2017}'s Fig.~2;~\citealt{raghavan_survey_2010}).
Another reason for the lower measured companion rates could be that planetary 
systems are less likely to have 
binary companions (as~\citealt{kraus_impact_2016} argued for close binary 
companions).
The uptick in the companion rate for Jupiters is likely tied to a large 
astrophysical false positive rate~\citep{santerne_sophie_2012}.
Going from Neptunes to Earths, the data suggest a weak increase in the 
detected planet companion fraction, perhaps of a few percent.
It will be interesting to see whether this effect is borne out by further 
observations.




\begin{comment}
\paragraph{Independent approaches for estimating binarity's effects}
T. Barclay et al.\! (in preparation) have performed the exercise of taking 
stars selected by the {\it Kepler}\ team, pairing them with a population of 
secondaries, injecting a realistic distribution of planet radii, 
and then comparing the inferred occurrence rates with the true ones.
In their model, they find that binarity leads to an inferred rate of 
Earth-sized planets $\approx 10\%$ less than the true rate.
In our Model \#3, if all $Z_i$'s are equal (a plausible assumption in 
the lack of evidence to the contrary), the underestimate is by a comparable 
16\%.
\end{comment}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\input{conclusion}

\section{Conclusion}
\label{sec:conclusion}

This study presented simple models for how binarity affects occurrence 
rates measured by transit surveys.
The simplest of these models (Sec.~\ref{sec:simplest}) provided an 
order-of-magnitude estimate that showed we would need very high twin binary 
fractions for binarity to affect apparent occurrence rates by more than 
$\sim$factors of two.

We then gave a general formula for the apparent rate density inferred by an 
observer ignoring binarity (Eq.~\ref{eq:general_Gamma_a}).
As input, this equation requires a volume-limited mass ratio distribution 
$f(q)$, and the true rate densities for planets around singles, 
primaries, and secondaries.
The assumptions that make the model tractable are:
\begin{enumerate}
    \item the transit survey is SNR-limited;
    \item the true properties of all the singles and primaries are known to 
    the observer;
    \item the observers assume that binaries have the same properties as the 
    primaries;
    \item there are functions $L(M)$ and $R(M)$ that specify a star's 
    luminosity and radius in terms of its mass.
\end{enumerate}
Allowing for these conditions, many results follow:
\begin{itemize}
%
\item Assuming a power-law planet radius distribution, and that the same 
number of planets orbit singles, primaries, and secondaries, binarity 
influences apparent planet occurrence rates around Sun-like stars at the 
$\sim$few percent level from radii $2r_\oplus \lesssim r\a \lesssim 
17r_\oplus$ (Sec.~\ref{sec:model_2}).
%
\item Assuming a broken-power law planet radius distribution, with 
\citet{howard_planet_2012}'s exponent at $r > 2r_\oplus$ and a constant 
occurrence at $r < 2r_\oplus$, there is a ``bump'' in the apparent rate 
density at $r\a < 2r_\oplus$, leading to a relative error $\delta \Gamma_0 = 
|\Gamma_0 - \Gamma\a|/\Gamma_0$ of at most $\approx 50\%$ 
(Fig.~\ref{fig:occ_rate_model_3_log}).
Although this is smaller than current systematic uncertainties on the 
occurrence rates of Earth-sized planets, this means that binarity could
eventually become an important component of the $\eta_\oplus$ error budget.
%
\item Binarity ``fills in'' gaps in the radius distribution 
(Fig.~\ref{fig:model_4}), by an amount that could affect precise measurements 
of the depth, width, and slope of \citet{fulton_california-_2017}'s radius 
gap, in the event that planets are not carefully vetted with high resolution 
imaging.
%
\item Binarity does not lead to smaller apparent HJ occurrence rates 
(Fig.~\ref{fig:gaussian_HJ}).
This assumes a Gaussian planet radius distribution, similar to that reported 
by~\citet{petigura_CKS_2017}.
%
\item Detected planets with $r\a \gtrsim 0.5r_\oplus$ that are revealed by 
high resolution imaging surveys to exist in binaries are more likely to orbit 
the primary (Fig.~\ref{fig:frac_model_3}).
%
\item Near the ``break'' in the rate distribution ($\approx 2r_\oplus$), 
the fraction of detected planets with binary companions increases by 
$\approx 5-10\%$ (Fig.~\ref{fig:frac_model_3}).
\end{itemize}

All of these results should be understood as only being strictly applicable 
when the assumptions listed above are met.
Otherwise, while it is only suggestive, our approach still provides 
helpful hints at how stellar binarity influences transit survey occurrence 
rates.





\acknowledgements{
It was a pleasure sharing discussions about this study with T. Barclay, W. 
Bhatti, and F. Dai.
This work made use of NASA's Astrophysics Data System Bibliographic Services.

\software{\texttt{numpy}~\citep{walt_numpy_2011}, 
\texttt{scipy}~\citep{jones_scipy_2001}, 
\texttt{matplotlib}~\citep{hunter_matplotlib_2007}, 
\texttt{pandas}~\citep{mckinney-proc-scipy-2010}
}
}

\newpage
\appendix
\section{Derivation of general formula for apparent occurrence rate}
\label{sec:appendix}

In this appendix, we derive Eq.~\ref{eq:general_Gamma_a}.
First, recall our definition of apparent rate density 
(Eq.~\ref{eq:defn_apparent_rate_density}).
Let us explicitly write $\pp=r$ and $\ps=M$; $R$ and $L$ are uniquely 
determined from the assumed stellar mass--radius--luminosity relation. We 
neglect the dependence on planetary orbital period.
The planets with $(r\a, M\a)$ are associated with 
systems of many different planetary and stellar properties, so $n_{\rm 
det}(r\a, M\a)$ is given by the convolution of the true rate density, 
$\Gamma(r, M)$, and $\mathcal{N}(r\a, M\a; r, M)$, the number (per 
unit $(r\a, M\a)$) of searchable stars that give $(r\a, M\a)$  when 
the true system actually has $(r, M)$. Mathematically,
\begin{align}
n_{\rm det}(r_a, M\a) &=
\sum_i n_{\rm det}^i(r_a, M\a) \\
&=
\sum_i \int \mathrm{d}r \mathrm{d}M \,
\mathcal{N}_{\rm s}^i(r_a,M\a; r,M)
\cdot\Gamma_i(r,M) \cdot p_{\rm tra}(r,M),
\label{eq:n_det}
\end{align}
where $i$ specifies the type of true host stars (0: single, 1: primary, 2: 
secondary).
The problem reduces to the evaluation of
\begin{equation}
\mathcal{N}_{\rm s}^i(\pp\a,\ps\a; \pp, \ps)
\end{equation}
for planets around single stars, primaries in binaries, and secondaries in 
binaries. 

\paragraph{Single stars} For $i=0$, 
\begin{equation}
\mathcal{N}_{\rm s}^0(r\a,M\a; r,M)
=\delta(r\a-r)\delta(M\a-M) N\s^0(r,M),
\end{equation}
so
\begin{equation}
n_{\rm det}^0(r\a, M\a)=N\s^0(r\a,M\a)\cdot \Gamma_0(r\a, 
M\a) \cdot p_{\rm tra}(r\a, M\a).
\end{equation}

\paragraph{Primaries in binaries}
The number of primaries with apparent parameters $(r_a,M\a)$ given the 
true parameters $(r,M)$ is
\begin{equation}
\mathcal{N}_{\rm s}^1(r_a, M\a; r, M)
=\int \mathrm{d}q\,f(q)\mathcal{N}_{{\rm s}, q}^1(r_a, M\a, q; r, M),
\label{eq:fancyN_s_1}
\end{equation}
where $f(q)$ is the volume-limited binary mass ratio distribution.

Since we assume $\ps\a=\ps_1$,
\begin{equation}
\mathcal{N}_{{\rm s},q}^1(r_a, M\a, q; r, M) \propto \delta(M\a-M).
\end{equation}
In this case, $\mathcal{N}_{{\rm s},q}^1$ is non-zero only at 
$r_a=R_a\sqrt{\delta_{\rm obs}}$, 
and the observed depth is
\begin{equation}
\delta_{\rm obs}
= \left[{r\over R(M\a)}\right]^2\times {L(M\a) \over L_{\rm sys}(M\a, q)}
\equiv \left[{r\over R(M\a)}\right]^2\times \mathcal{A}(q,M\a)^2,
\label{eq:delta_obs_primaries} 
\end{equation}
where
\begin{equation}
\mathcal{A}(q, M\a)=\sqrt{L(M\a) \over L_{\rm sys}(M\a, q)}.
\end{equation}
The normalization of $\mathcal{N}_{{\rm s},q}^1$ is given by the number of 
binaries that are searchable for a signal $\delta_{\rm obs}$ and that have the 
mass ratio $q$:
\begin{equation}
N_{\rm s}^0(\delta_{\rm obs}, 
L(M\a))\cdot
{n_b\over n_s}\left[L_{\rm sys}(M\a, q) \over L(M\a)\right]^{3/2}
=N_{\rm s}^0(\delta_{\rm obs}, L(M\a))
\cdot \frac{{\rm BF}}{1 - {\rm BF}} \cdot {1 \over \mathcal{A}(q,M\a)^3}.
\label{eq:primary_normalization}
\end{equation}
Thus,
\begin{align}
\notag
\mathcal{N}_{{\rm s}, q}^1(r_a, M\a, q; r, M)
&=N_{\rm s}^0(\delta_{\rm obs}, L(M\a))
\cdot \frac{{\rm BF}}{1 - {\rm BF}} \cdot {1 \over \mathcal{A}(q,M\a)^3}\\
&\times\delta \left[r_a-r\mathcal{A}(q,M\a)\right]\delta(M\a-M).
\label{eq:N_s_1}
\end{align}


\paragraph{Secondaries in binaries}
In this case, $M=qM_1=qM\a$, so
\begin{equation}
\mathcal{N}_{{\rm s},q}^2(r_a, M\a, q; r, M)
\propto \delta\left(M\a-{M\over q}\right).
\label{eq:fancyN_s_2_prop}
\end{equation}
Again $\mathcal{N}_{\rm s}^2$ is non-zero only at $r_a=R_a\sqrt{\delta_{\rm 
        obs}}$, but this 
time
\begin{equation}
\delta_{\rm obs} = \left[{r\over R(qM\a)}\right]^2 \times {L(qM\a) 
    \over L_{\rm sys}(M\a, q)}
    \equiv \left[{r\over R(M\a)}\right]^2\times \mathcal{B}(q,M\a)^2,
\end{equation}
where
\begin{equation}
\mathcal{B}(q, M\a)={R(M\a)\over R(qM\a)}\sqrt{{L(qM\a) \over L_{\rm 
            sys}(M\a, q)} }.
\end{equation}
The normalization remains the same as the previous case (we are counting the 
searchable stars at a given observed depth $\delta_{\rm obs}$, and the total 
luminosity of the binary is the same).
Thus,
\begin{equation}
\mathcal{N}_{\rm s}^2(r_a, M\a; r, M)
=\int \mathrm{d}q\,f(q)\mathcal{N}_{{\rm s}, q}^2(r_a, M\a, q; r, M),
\end{equation}
where
\begin{align}
\notag
\mathcal{N}_{{\rm s},q}^2(r\a, M\a, q; r, M)
&=N_{\rm s}^0(\delta_{\rm obs}, L(M\a)) \cdot \frac{{\rm BF}}{1 - {\rm BF}} 
\cdot {1 \over \mathcal{A}(q,M\a)^3}\\
&\times 
	\delta \left[r_a-r\mathcal{B}(q,M\a)\right]
	\delta\left(M\a-{M\over q}\right).
\label{eq:mathcal_N_s_2}
\end{align}

One might worry in Eq.~\ref{eq:mathcal_N_s_2} that we opt to write 
$\mathcal{N}\s^2 \propto \delta(M\a - M/q)$, rather than $\propto \delta(M\a q 
- M)$ or some other delta function with the same functional dependence, 
but a different normalization once integrated.
We do this because the delta function in Eq.~\ref{eq:mathcal_N_s_2} is 
defined with respect to the measure ${\rm d}M\a$, not ${\rm d}M$.
This is because $\mathcal{N}\s^2$ is defined as a number per $r\a$, per $M\a$.

\paragraph{Number of detected planets}
Marginalizing per Eq.~\ref{eq:n_det}, we find
\begin{align}
\notag
n_{\rm det}^0(r\a, M\a)
&=\int\mathrm{d}r\mathrm{d}M\,\mathcal{N}_{\rm s}^0(r\a, M\a; r, M)
\cdot\Gamma_0(r, M) \cdot p_{\rm tra}(M)\\
&=N\s^0(\delta_{\rm obs}, L(M\a))\cdot\Gamma_0(r\a, M\a) \cdot p_{\rm 
    tra}(M\a),
\label{eq:n_det_0}
\end{align}
and
\begin{align}
\notag
n_{\rm det}^1(r\a, M\a)
&=\int\mathrm{d}r\mathrm{d}M\,\mathcal{N}_{\rm s}^1(r\a, M\a; r, M)
\cdot\Gamma_1(r, M) \cdot p_{\rm tra}(M)\\
&=N\s^0(\delta_{\rm obs}, L(M\a))\cdot p_{\rm tra}(M\a) \cdot
{\mathrm{BF}\over{1-\mathrm{BF}}} \int {\mathrm{d}q \over 
    \mathcal{A}^4}\,f(q)\,\Gamma_1\left({r_a\over\mathcal{A}}, M\a\right).
\label{eq:n_det_1}
\end{align}
Finally,
\begin{align}
n_{\rm det}^2(r\a, M\a)
\notag
&=\int\mathrm{d}r\mathrm{d}M\,\mathcal{N}_{\rm s}^2(r\a, M\a; r, M)
\cdot\Gamma_2(r, M) \cdot p_{\rm tra}(M)\\
&=
N\s^0(\delta_{\rm obs}, L(M\a))\cdot \frac{{\rm BF}}{1 - {\rm BF}}
\int {q \mathrm{d}q \over 
{\mathcal{A}^3\mathcal{B}}}\,f(q)\,\Gamma_2\left({r_a\over\mathcal{B}}, 
qM\a\right)\,p_{\rm 
    tra}(qM\a).
\label{eq:n_det_2}
\end{align}


\paragraph{General formula for apparent occurrence rate}
Using the above results, the apparent rate density,
\begin{align}
\Gamma\a(r\a,M\a) &= 
\frac{1}{N_{\rm s,a}(r\a,M\a) p_{\rm tra}(r\a,M\a)} \times
\sum_i n_{\rm det}^i (r\a,M\a),
\end{align}
evaluates to

\begin{align}
\notag
\Gamma\a(r\a,M\a) &= {1\over 1+\mu(\mathrm{BF}, M\a)}\times
\left\{ \Gamma_0(r\a, M\a)+ 
\frac{{\rm BF}}{1 - {\rm BF}}
\left[ \int {\mathrm{d}q \over \mathcal{A}^4}\,f(q)\,\Gamma_1\left({r\a\over 
    \mathcal{A}}, 
M\a\right)\,
\right.   
\right. \\
& \quad\quad\quad\quad\quad \left.\left.
+\int {q \mathrm{d}q \over 
    {\mathcal{A}^3\mathcal{B}}}\,f(q)\,\Gamma_2\left({r\a\over 
    \mathcal{B}}, 
qM\a\right)\,
{R(qM\a) \over R(M\a)}
q^{-1/3} \right]	\right\}.
\label{eq:final_formula}
\end{align}
This equation is used to derive Eqs.~\ref{eq:model5_apparent_rate_density} 
and~\ref{eq:powerlaw_vary_binary}, and is numerically integrated to create 
Figs.~\ref{fig:occ_rate_model_3_log},~\ref{fig:model_4}, 
and~\ref{fig:gaussian_HJ}.
It is validated in limits in which it is possible to write down the answer 
(e.g., Eq.~\ref{eq:model_1_apparent_rate_density}), and also against a Monte 
Carlo realization of the twin binary models (Secs.~\ref{sec:model_1} 
and~\ref{sec:model_2}).

Noting the definition of $\mu$ in Eq.~\ref{eq:mu_general},
Eq.~\ref{eq:final_formula} can also be expressed as
\begin{align}
\notag
\notag
\Gamma\a(r\a,M\a) &= {1\over 1+\mu(\mathrm{BF}, M\a)} \cdot
   \left[ \Gamma_0(r\a, M\a)\phantom{\tilde \Gamma}\right.&\\
   &\left.+\mu(\mathrm{BF}, M\a)\cdot
   %\tilde\Gamma_1(r\a, M\a)
   \left\langle {1 \over \mathcal{A}}\cdot\Gamma_1\left({r\a\over\mathcal{A}}, M\a\right)
   +%\tilde\Gamma_2(r\a, M\a)
   {q \over \mathcal{B}}\cdot\Gamma_2\left({r\a\over\mathcal{B}}, qM\a\right) \cdot {R(qM\a) \over R(M\a)}q^{-1/3}\right\rangle
   \right],
\end{align}
where the angle brackets denote averaging over $f(q)/\mathcal{A}^3$. This form
shows that the fraction $\mu$ and mass ratio distribution 
$f(q)/\mathcal{A}^3$ of binaries {\it in the searchable volume} are enough to 
describe the contributions from binaries to $\Gamma\a$.
The fraction $\mu$ gives the relative contributions from singles and binaries,
and $f(q)/\mathcal{A}^3$ weights the contributions from binaries with various 
mass ratios.
The apparent rate density at each mass ratio ({\it i.e.}, the terms in
the angle brackets) is the rate density of systems that give the apparent
$(r\a, M\a)$, corrected for the overestimated transit probability around
secondaries.




\newpage
\input{hj_rates.tex}


\newpage
\bibliographystyle{yahapj}                            
\bibliography{bibliography} 

\end{document}
