\documentclass[12pt,modern]{aastex61}
\usepackage{graphics,graphicx}
\usepackage{hyperref}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{comment}
\usepackage{grffile} % checks for multiple dots in figure filenames
\usepackage{empheq} % for boxing equations
\newcommand*\widefbox[1]{\fbox{\hspace{0.2cm}#1\hspace{0.2cm}}}

%% Reintroduced the \received and \accepted commands from AASTeX v5.2
%\received{July 1, 2016}
%\revised{September 27, 2016}
%\accepted{\today}
%% Command to document which AAS Journal the manuscript was submitted to.
%% Adds "Submitted to " the arguement.
\submitjournal{AAS journals.}


\shortauthors{Bouma et al.}
\shorttitle{Binarity and Occurrence Rates}


\newcommand{\pp}{\mathcal{P}}
\newcommand{\ps}{\mathcal{S}}
\renewcommand{\a}{_{\rm a}}
\newcommand{\s}{_{\rm s}}
\newcommand{\p}{_{\rm p}}
\renewcommand{\d}{_{\rm d}}
\begin{document}
    
\title{ The effects of binarity on planet occurrence rates measured by transit 
surveys}
%
\correspondingauthor{L. Bouma}
\email{luke@astro.princeton.edu}
%
\author{L. G. Bouma}
\affiliation{
    Department of Astrophysical Sciences,
    Princeton University,
    4 Ivy Lane, Princeton, NJ 08540, USA}
\author{K. Masuda}
\affiliation{
    Department of Astrophysical Sciences,
    Princeton University,
    4 Ivy Lane, Princeton, NJ 08540, USA}
\author{J. N. Winn}
\affiliation{
    Department of Astrophysical Sciences,
    Princeton University,
    4 Ivy Lane, Princeton, NJ 08540, USA}
%
%
\begin{abstract}
%
This study develops simplified models of signal-to-noise limited transit 
surveys, in order to clarify the biases that stellar binarity introduces
to occurrence rate measurements.
Particular attention is paid to dilution of observed planet radii, errors in 
star counts, and detection efficiencies.
Free parameters in our models include the true radius distribution of planets, 
and the relative numbers of planets orbiting secondaries, primaries, and 
single stars.
In the simplest possible case, all stellar systems are either single or twin 
binaries, and all planets are identical. If so, then we find that ignoring 
binarity leads to an underestimate of the occurrence at the true radius by a 
multiplicative factor of $0.76$ (assuming a 10\% twin binary fraction).
Using more realistic models for the stellar population and planetary 
radii, we find that the occurrence of Earth-sized planets can be overestimated 
by at most $\approx 50\%$ when ignoring binarity~--~at present far smaller 
than systematic uncertainties on real $\eta_\oplus$ measurements.
We quantify how gaps in the intrinsic planet radius distribution are filled 
in when binarity is neglected.
Our models suggest that for most of the observed radius distribution 
($r>2r_\oplus$), ignoring binarity only leads to errors in inferred occurrence 
rates at the $\lesssim 10\%$ level.
One corollary is that binarity is unlikely to strongly influence the HJ rate 
discrepancy.
%
\end{abstract}
%
\keywords{
    methods: data analysis ---
    planets and satellites: detection ---
    surveys}
%
%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\input{introduction}

\section{Introduction}

A group of binarity-ignoring astronomers wants to measure the mean number of 
planets of a certain type per star of a certain type.
They perform a wide-field photometric search for planets that transit, and 
discover all for which
\begin{equation}
\left(\frac{{\rm S}}{{\rm N}}\right)
= ({\rm const}) \cdot \delta_{\rm obs} L_{\rm sys}^{1/2} d^{-1}
> \left(\frac{{\rm S}}{{\rm N}}\right)_{\rm floor}.
\label{eq:S_N_thresh}
\end{equation}
The observed transit depth $\delta_{\rm obs}$ constitutes the signal, ${\rm 
S}$. The survey is shot-noise dominated, and the fractional photon noise 
${\rm N}$ scales as the inverse root of the photon flux received from any 
stellar system, ${\rm N} \propto (L_{\rm sys}/d^2)^{-1/2}$, for $L_{\rm sys}$ 
the system luminosity and $d$ its distance.
The solid angle coverage, telescope area, and survey duration are part of the 
``const'' term of Eq.~\ref{eq:S_N_thresh}. The transit duration also 
affects detectability, but we omit it in this work for brevity.

To compute an occurrence, at every planetary and stellar property the 
astronomers choose the stars around which the planets of interest appeared to 
be searchable.
Correcting for the geometric transit probability $p_{\rm tra}$, they report an 
apparent rate density,
\begin{equation}
\Gamma\a(\pp\a, \ps\a) = \frac{n_{\rm det}(\pp\a, \ps\a)}{N_{\rm s,a}(\pp\a, 
    \ps\a)} \times \frac{1}{p_{\rm tra}(\pp\a, \ps\a)}.
\label{eq:defn_apparent_rate_density}
\end{equation}
where $\pp\a$, $\ps\a$ are the apparent planetary and stellar parameters.
The quantity $N_{\rm s,a}(\pp\a, \ps\a)$ is the number of unresolved 
point-sources on the sky that appear to be searchable, and
$n_{\rm det}(\pp\a, \ps\a)$ is the number of detected planets, per unit 
$\pp\a$ and $\ps\a$. 

There are many potential pitfalls.  Some genuine transit signals can be missed
by the detection pipeline.  Some apparent transit signals are spurious, from
noise fluctuations, failures of `detrending', or instrumental effects.  Stars
and planets can be misclassified due to statistical and systematic errors in
the measurements of their properties.  Poor angular resolution causes false
positives due to blends with background eclipsing binaries. {\it Et cetera}.

Here we focus on problems that arise from the fact that many stars exist in 
multiple star systems.
For simplicity, we consider only binaries, and we assume that they are all 
bound and spatially unresolved.

An immediate complication is that, due to dynamical stability or some 
aspect of planet formation, the occurrence rate of planets might differ 
between binary and single-star systems.
In an observed sample of stars that contains both singles and binaries, the 
detected planets would then be drawn from different intrinsic 
distributions for the occurrence rates in single star systems, 
about primaries, and about secondaries~\citep[{\it 
e.g},][]{wang_occurrence_2015}.

Outside of astrophysical differences, every term in 
Eq.~\ref{eq:defn_apparent_rate_density} is observationally-biased.
There are errors in $n_{\rm det}(\pp\a,\ps\a)$ due to misclassification of 
both planet radii and stellar properties.
There are errors in $N_{{\rm s,a}}(\pp\a,\ps\a)$ because an apparently 
searchable point on the sky might include two searchable stars.
There are errors in $p_{\rm tra}(\pp\a,\ps\a)$ because stars in binaries may 
have different masses and radii than assumed in the single-star case.
Binarity might also affect the observers' ability to correctly select 
searchable stars (but see Sec.~\ref{sec:discussion} for discussion of this 
issue).

Correcting for binarity's observational biases is non-trivial.
For instance, in counting the number of searchable stars, even after realizing 
that binaries count as two stars, one must note that the multiplicity fraction 
of stars that are searchable for a given observed transit depth is greater 
than that the multiplicity fraction in a volume limited sample.
This is the familiar Malmquist bias: at a fixed $\delta_{\rm obs}$, binaries 
are searchable out to larger distances than single stars because they are more 
luminous.
While this is what biases detectability, separate effects bias interpretation:
ignoring binarity, the (apparent) radii assigned to planets in binaries will 
typically be smaller than the true radii.
The apparent and true radii differ because of diluting flux, and possibly 
because the planet is assumed to orbit the wrong 
star.

To gain intuition for the many observational biases at play,
we consider a set of idealized transit surveys.
First, we discuss the simplest possible cases (Sec.~\ref{sec:simplest}), in 
which all planets have identical properties, and all stars have identical 
properties except that some are in binaries.
The straightforward thought-experiments of Sec.~\ref{sec:simplest} are then 
generalized in Sec.~\ref{sec:general_formula} to allow for varying populations 
of secondaries, and for varying intrinsic occurrence rate distributions.
Sec.~\ref{sec:more_complicated} investigates questions of interest, 
including (a) measurements of $\eta_\oplus$, (b) the ``hot Jupiter rate 
discrepancy'', and (c) \citet{fulton_california-_2017}'s 
recently discovered ``valley''.
We discuss what our models suggest about binarity's biasing effects in 
Sec.~\ref{sec:discussion}, and conclude in Sec.~\ref{sec:conclusion}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\input{methods}

\section{The simplest possible transit survey models}
\label{sec:simplest}

\subsection{Twin binaries, identical stars, identical planets}
\label{sec:model_1}

\begin{figure}[!tb]
    \begin{center}
        \includegraphics[width=0.6\textwidth]{figures/visualize_volumes.pdf}
    \end{center}
    \caption{
        Cartoon of the searchable volumes for single stars ({\it left}), and 
        twin binaries ({\it right}).
        This model assumes all stars have equal mass and luminosity, and 
        all planets have the same true radius $r=r\p$.
        {\it Top:} At an apparent radius $r\a=r\p$,
        the observer searched twin binaries out to a larger         
        distance, $\sqrt{2}\times$ that of single stars.
        Because of dilution, there are no planets in twin binaries with 
        $r\a=r\p$.
        {\it Middle:} At an apparent radius $r\a=r\p/\sqrt{2}$, the 
        searched volumes are half those at $r\a=r\p$. 
        The only detected planets with $r\a=r\p/\sqrt{2}$ orbit twin binaries.
        {\it Bottom:} Planets with a true radius $r=r\p$ are searchable to 
        a maximum distance $d_0$ around singles, and $d_0/\sqrt{2}$ around 
        twin binaries.
    }
    \label{fig:model_1_volumes}
\end{figure}

Since the effects of binarity are most pronounced when the two components are 
similar, we begin by considering a universe in which all planets are 
identical, and all stars are identical except that some fraction of them exist 
in binaries. The goal of this thought experiment is to compare the occurrence 
inferred by observers ignoring binarity with the true occurrence in single 
star systems.

First, what are the possible apparent radii of detected planets?
If the true planet radius is $r=r\p$, then planets in singles will be 
detected with the identical apparent radii: $r\a = r\p$.
Conversely, all detections in twin binaries will have apparent radii 
$r\a=r\p/\sqrt{2}$, because they are diluted.
For an unresolved point-source,
\begin{equation}
\delta_{\rm obs}
= \left(\frac{r\a}{R\a}\right)^2
= \left[{r\over R_{\rm host}}\right]^2\times {L_{\rm host} \over L_{\rm 
        sys}(M_1, q)},
\label{eq:delta_obs_general} 
\end{equation}
where $R_{\rm host}$ ($L_{\rm host}$) is the planet-host's stellar radius 
(luminosity), $R\a$ is the apparent stellar radius, $L_{\rm sys}=L_1+L_2 = 
L(M_1) + L(qM_1)$ is the system luminosity, and $q=M_2/M_1$ is the binary mass 
ratio.
We assume that the stellar radius and luminosity are uniquely related to the 
stellar mass.
The observers, with no a priori knowledge of the distance to a system, would 
measure a flux, assume a stellar mass $M\a=M_1$, and estimate both a stellar 
radius $R\a = R(M\a)$ and an under-luminous system luminosity of $L_{\rm 
sys,a}(M\a) = L(M\a)$.

The planets will be detected if and only if their host stars are searchable.
For a fixed signal-to-noise floor, there is a maximum searchable 
distance~\citep{pepper_using_2003,pepper_searching_2005}.
From Eq.~\ref{eq:S_N_thresh}, this maximum searchable distance scales as
\begin{equation}
d(\delta_{\rm obs}, L_{\rm sys}) \propto \delta_{\rm obs} \cdot L_{\rm 
    sys}^{1/2}.
\end{equation}
Assuming that stars are uniformly distributed in space, the number 
of searchable stars $N\s$ is then proportional to
\begin{equation}
N\s(\delta_{\rm obs}, L_{\rm sys}) \propto n \delta_{\rm obs}^3 L_{\rm 
    sys}^{3/2},
\label{eq:N_searchable_prop}
\end{equation}
where $n$ is the number per unit volume of {\it e.g.}, single star, or binary 
systems.
We neglect the dependence of $n$ on stellar type.

The searchable volumes for our thought experiment are illustrated 
in Fig.~\ref{fig:model_1_volumes}.
At an apparent radius equal to the true radius ($r\a=r\p$), single stars 
with $d<d_0$ are searchable.
Binaries with $r\a=r\p$ are also searchable, out to $\sqrt{2}d_0$. 
However, in this model no such systems exist; all planets in twin binaries 
have true radii $r=r\p$, and so are observed with apparent radii 
$r\a=r\p/\sqrt{2}$, out to $d_0/\sqrt{2}$.
At an apparent radius of $r\a=r\p/\sqrt{2}$, there could also be planets with 
true radii $r=r\p/\sqrt{2}$ orbiting singles~---~however none of these exist 
in this model.

How many planets are detected?
If we assume that there are $N\s^0(r\a)$ singles that are searchable for 
planets with $r\a$, and that there are $Z_0$ planets per single, then 
single stars contribute
\begin{equation}
n_{\rm det}^0(r\a) = N\s^0(r\a) Z_0 p_{\rm tra} \cdot \delta(r\a - r_p)
\end{equation}
planet detections (per unit $r\a$), where $\delta$ is the Dirac delta function.

We can write similar equations for the binaries.
First though, we define a ratio $\mu \equiv N\s^{\rm b}(r\a) / N\s^0(r\a)$ 
between the number of searchable binary systems and the number of searchable 
singles at a given $r\a$.
This quantity is useful because although $N\s^{\rm b}$ and $N\s^0$ vary
as a function of the observed transit depth, $\mu$ remains fixed.
Applying this definition, at $r\a=r\p/\sqrt{2}$, some detections will come 
from primaries,
\begin{equation}
n_{\rm det}^1(r\a) =
\mu N\s^0(r\a) Z_1 p_{\rm tra}
\cdot \delta\left(r\a - \frac{r\p}{\sqrt{2}}\right),
\end{equation}
and some from secondaries,
\begin{equation}
n_{\rm det}^2(r\a) = 
\mu N\s^0(r\a) Z_2 p_{\rm tra}
\cdot \delta\left(r\a - \frac{r\p}{\sqrt{2}}\right),
\end{equation}
where $Z_1$ is the number of planets per primary, $Z_2$ is the number of 
planets per secondary, and $p_{\rm tra}$ is the same for identical stars.
In the case of twin binaries, Eq.~\ref{eq:N_searchable_prop} gives $\mu = 
2^{3/2} n_{\rm b}/n_{\rm s} = 2^{3/2} {\rm BF}/(1-{\rm BF})$, for ${\rm BF}$ 
the binary fraction\footnote{The binary fraction is the fraction of systems in 
a volume-limited sample that are binary. It is equivalent to the multiplicity 
fraction if there are no triple, quadruple, or higher order multiples.
}.

The last item we need to write down the apparent rate density $\Gamma\a(r\a)$ 
is the number of unresolved point-sources on sky, $N_{\rm s,a}$.
Assuming that the apparent stellar radius is fixed, then given the 
apparent planet radius $r\a$,
\begin{equation}
N_{\rm s,a}(r\a) = N\s^0(r\a) \times (1 + \mu)
\label{eq:apparentlysearchable_to_searchable}
\end{equation}
relates the number of apparently searchable point-sources to the number of 
searchable singles.
From the discussion above, it should be clear that there are in fact
$N\s^0(r\a)\times (1 + 2\mu)$ searchable stars at any given $r\a$; the 
observers are under-counting.

Using Eq.~\ref{eq:defn_apparent_rate_density}, the apparent rate density 
computed without considering binarity is
\begin{align}
\Gamma\a(r\a) = 
\frac{1}{1+\mu} Z_0 \cdot
\delta(r\a-r\p)  +
\frac{\mu}{1+\mu} (Z_1 + Z_2) \cdot
\delta\left(r\a-\frac{r\p}{\sqrt{2}} \right).
\label{eq:model_1_apparent_rate_density}
\end{align}
The number of searchable singles at a given apparent radius, 
$N\s^0(r\a)$, makes no appearance.
The observer's errors in Eq.~\ref{eq:model_1_apparent_rate_density} are 
(A) under-counting the number of searchable stars at any apparent radius;
and
(B) inferring radii in binary systems that are all $\sqrt{2}$ too small.

\begin{figure}[!tb]
    \begin{center}
        \includegraphics[width=.6\textwidth]{figures/occ_rate_vs_radius_model_1_brokenx.pdf}
    \end{center}
    \vspace{-0.5cm}
    \caption{
        Inferred occurrence rates over $0.01r_\oplus$ bins in planet 
        radius, for a model with identical stars, identical planets, and twin 
        binaries.
        We assume a twin binary fraction of ${\rm BF}=0.1$, and that all 
        stars (single, primary, and secondary) host planets at equal 
        rates.
        If the true planet radius is $r\p$, all planets detected in binaries 
        will have apparent radii $r\a = r\p/\sqrt{2}$.
    }
    \label{fig:occ_rate_model_1}
\end{figure}

To assess the severity of these errors, we need to assume a binary fraction, 
and to know the true number of planets per single, primary, and secondary star 
($Z_0,Z_1,$ and $Z_2$).
For the former,
\citet{raghavan_survey_2010} found a multiplicity 
fraction of 0.44 for primaries with masses from $0.7M_\odot$ to $1.3M_\odot$, 
which we take as a binary fraction. 
``Twin binaries'' are perhaps 10-20\% of the binaries in a volume-limited 
sample, depending on how ``twin'' is defined.
Thus a representative twin binary fraction for this model is ${\rm BF}\approx 
0.05$-$0.1$. 
For the latter, we take $Z_0=Z_1=Z_2=0.5$, and plot the resulting occurrence 
rates as a function of planet radius in Fig.~\ref{fig:occ_rate_model_1}.

Our point for comparison is the rate density for single stars,
\begin{equation}
\Gamma_0(r) = Z_0 \cdot \delta(r-r\p).
\end{equation}
We can define a rate density ``correction factor'', $X_\Gamma$, as the ratio 
of the apparent to single star rate density,
\begin{equation}
X_\Gamma(r) \equiv \left. \frac{\Gamma_a(r\a)}{\Gamma_0(r)} \right|_{r\a 
    \rightarrow r}.
\end{equation}
Continuing in the assumption that the number of planets per single, primary, 
and secondary star are equal, we find a rate density 
correction factor at the true planet radius of $1/(1+\mu)$.
This yields a correction of 0.76 if ${\rm BF}=0.1$, and 0.87 if ${\rm 
    BF}=0.05$. Rephrasing the result, if the twin binary fraction were 
$(2^{3/2}+1)^{-1}\approx 0.26$, then the apparent rate at $r\a=r\p$ would be 
half the true rate at $r=r\p$.
For most stellar types, the twin binary fraction is not that high.

An alternative assumption is that secondaries do not host planets. In that 
case, $Z_0=Z_1$, and $Z_2=0$. The correction to the rate density at the true 
planet radius becomes $(1+2\mu)/(1+\mu)^2$.
This evaluates to 0.94 if ${\rm BF}=0.1$, and 0.98 if ${\rm BF}=0.05$.
While it seems unlikely that secondaries are planet-less, 
it is worth noting that $\Gamma\a/\Gamma$ is sensitive to the relative number 
of planets per single, primary, and secondary.

\subsection{Twin binaries, identical stars, two planet sizes}

A simple extension to the previous example will help us further distinguish 
the detected populations.
Consider now a universe that is the same in every respect to that of 
Sec.~\ref{sec:model_1}, except now half of planets have radii $r\p$, while 
the other half have $r\p/\sqrt{2}$.
The true rate densities are
\begin{equation}
\Gamma_i(r) = \frac{Z_i}{2} \left[
\delta(r-r\p) + \delta\left(r-\frac{r\p}{\sqrt{2}}\right)
\right], \quad {\rm for}\  i \in \{ 0,1,2 \},
\end{equation}
where as always $i=0$ corresponds to singles, $i=1$ to primaries, and $i=2$ to 
secondaries, and the $Z_i$'s are the number of planets per star of each type.

Following an identical line of reasoning as before, the apparent rate density 
can be written
\begin{align}
\notag
\Gamma\a(r\a) &=
\frac{1}{2(1+\mu)} \left[
Z_0 \cdot \delta(r\a - r\p)
+
\left[Z_0 + \mu (Z_1 + Z_2)
\right] \cdot \delta\left(r\a - \frac{r\p}{\sqrt{2}}\right) 
\right. \\
&\quad\quad\quad\quad\quad\quad\quad\quad+
\left.
\mu(Z_1 + Z_2) \cdot \delta\left(r\a - \frac{r\p}{2}\right)
\right].
\label{eq:two_radii_twins}
\end{align}
The important qualitative point of this equation is that at $r\a = 
r\p/\sqrt{2}$, two populations contribute.
The first population is singles with $r=r\p/\sqrt{2}$, and the second is twin 
binaries with $r=r\p$.
Both populations are detected out to the same maximum searchable distance.
Just as with Eq.~\ref{eq:apparentlysearchable_to_searchable}, we will have a 
cancellation of $N\s^0(r\a)$ terms, leaving only the $\mu$ weights.




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{General formula for apparent occurrence rate}
\label{sec:general_formula}

To generalize the procedure of Sec.~\ref{sec:simplest}, we consider a S/N 
limited transit survey in which all the primaries and single stars have 
identical properties.
For example, they might all be solar analogs, roughly similar to 
the stars that {\it Kepler} surveyed~\citep{batalha_selection_2010}.
We let the properties of the secondaries vary, and assume that there are some 
functions $L(M)$ and $R(M)$ that specify a star's luminosity and radius in 
terms of its mass.
We then allow for an arbitrary volume-limited mass ratio distribution 
$f(q)$, and also for arbitrary true rate densities for singles, primaries, 
and doubles ($\Gamma_0, \Gamma_1, \Gamma_2$).
Since the properties of the secondaries vary, we must consider not only the 
dependence of the rate densities on planet radius, but also on stellar mass.
We presume that the observers always take the properties of a binary system to 
be those of the primary.

Given this laundry-list of assumptions, a general formula for the apparent 
rate density follows:
\begin{align}
\notag
\Gamma\a(r\a,M\a) &= {1\over 1+\mu(\mathrm{BF}, M\a)}\times
\left\{ \Gamma_0(r\a, M\a)+ 
\frac{{\rm BF}}{1 - {\rm BF}}
\left[ \int {\mathrm{d}q \over \mathcal{A}^4}\,f(q)\,\Gamma_1\left({r\a\over 
    \mathcal{A}}, 
M\a\right)\,
\right.   
\right. \\
& \quad\quad\quad\quad\quad \left.\left.
+\int {q \mathrm{d}q \over 
    {\mathcal{A}^3\mathcal{B}}}\,f(q)\,\Gamma_2\left({r\a\over 
    \mathcal{B}}, 
qM\a\right)\,
{R(qM\a) \over R(M\a)}
q^{-1/3} \right]	\right\},
\label{eq:general_Gamma_a}
\end{align}
where 
\begin{equation}
\mathcal{A}(q, M\a)=\sqrt{L(M\a) \over L_{\rm sys}(M\a, q)}
\end{equation}
and
\begin{equation}
\mathcal{B}(q, M\a)={R(M\a)\over R(qM\a)}\sqrt{{L(qM\a) \over L_{\rm 
            sys}(M\a, q)} }
\end{equation}
are the dilution terms appropriate to primaries and secondaries, and as before 
${\rm BF}$ is the volume-limited binary fraction.

A derivation of Eq.~\ref{eq:general_Gamma_a} is given in the 
\hyperref[sec:appendix]{Appendix}; here we highlight its qualitative 
features.
The terms inside the curly braces $\{ \ldots \}$ are the sum of 
the apparent rate densities from singles, primaries, and secondaries.
The contribution from singles is not affected by binarity.
In the contributions from primaries and secondaries,
planets with $(r\a, M\a)$ are associated with 
systems of many different planetary and stellar properties.
This means that $n_{\rm det}(r\a, M\a)$ is given by a convolution of the 
true rate density, $\Gamma(r, M)$, and the number per unit $(r\a, M\a)$ of 
searchable stars that give $(r\a, M\a)$  when the true system actually has 
$(r, M)$.
This convolution has been evaluated, leaving only a dependence on the mass 
ratio distribution.
Finally, the latter term in the apparent rate density of secondaries comes 
from a correction for the overestimated transit probability.


\paragraph{Ratio of searchable binaries to singles}
We must also specify the exact form of $\mu({\rm BF},M\a)$, the ratio of 
the number of searchable binary systems to singles.
Given the observed signal $\delta_{\rm obs}$ and apparent stellar mass $M\a$, 
recall that the maximum searchable distance for singles and binaries are 
proportional to $\delta_{\rm obs}\cdot L(M\a)^{1/2}$ and $\delta_{\rm 
obs}\cdot [L(M\a)+L(qM\a)]^{1/2}$.
Applying Eq.~\ref{eq:N_searchable_prop},
\begin{equation}
\mu({\rm BF},M\a) = 
\frac{N\s^{\rm b}(r_a)}{N_s^0(r\a)}=
\int_0^1 {n_{\rm b}\over n_{\rm s}}\left[1+{L(qM\a) \over L(M\a)}\right]^{3/2} 
f(q)\mathrm{d}q.
\label{eq:mu_general}
\end{equation}

If $\mathrm{BF}$ is independent of $q$, $L \propto M^\alpha$, and $f(q) 
\propto q^\beta$, this reduces to
\begin{equation}
\mu =\frac{{\rm BF}}{1 - {\rm BF}}\cdot {1\over{1+\beta}}\int_0^1 
\left(1+q^\alpha\right)^{3/2} q^\beta\mathrm{d}q,
\label{eq:mu_power_laws}
\end{equation}
which may be written in a closed form using the hypergeometric function.

\begin{figure}[!tb]
    \centering
    \includegraphics[width=0.6\textwidth]{figures/mass_ratio_distribution.pdf}
    \caption{
        The mass ratio distribution for a magnitude-limited sample of 
        binary stars, in which the underlying volume-limited distribution is 
        uniform, qualitatively similar to {\it e.g.}, 
        \citet{raghavan_survey_2010}'s Fig.~16.
        At a given observed depth, the searchable binaries in a transit survey 
        are magnitude-limited.
    }
    \label{fig:q_distribn_mag_limited}
\end{figure}

This can be understood as a Malmquist bias: at fixed observed transit 
depth, for singles and primaries with the same luminosity, binaries are 
searchable to a greater distance.
In particular, the sample of searchable binaries is magnitude-limited.
Given a searchable binary, the probability it having a mass ratio $q$ 
scales as
\begin{equation}
p({\rm draw\ }q\,|\,{\rm system\ is\ binary}) \propto 
(1+q^\alpha)^{3/2} q^\beta 
\label{eq:Malmquist_bias}
\end{equation}
where $q^\beta$ is the volume-limited probability of drawing a binary of mass 
ratio $q$, and the first term is the Malmquist bias.
We show this magnitude-limited mass ratio distribution for the $\beta=0$ case 
in Fig.~\ref{fig:q_distribn_mag_limited}.
In Monte Carlo simulations of transit surveys, it is 
important to draw binaries from a correctly biased mass-ratio distribution 
\citep[\textit{e.g.},][]{bakos_hatsouth:_2013,sullivan_transiting_2015,
    gunther_new_2017}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\input{results}

\section{More complicated transit survey models}
\label{sec:more_complicated}
The following section applies our general equation for the apparent rate 
density (Eq.~\ref{eq:general_Gamma_a}) to study binarity's effects in more 
realistic regimes.
In general, we will write the rate density for each type of star, 
$\Gamma_i(r)$, as the product of a shape function and a constant:
\begin{equation}
\Gamma_i(r) = \frac{{\rm d}\Lambda_i}{{\rm d}r} = Z_i f_i(r),
\quad {\rm for\ }i\in\{0,1,2\},
\end{equation}
where as awlays, $i=0$ corresponds to single stars, $i=1$ to primaries of 
binaries, and $i=2$ to secondaries of binaries.
The shape function is normalized to unity.
The $Z_i$'s are each system type's occurrence rate $\Lambda_i$, integrated 
over all planetary radii. In other words, they are number of planets per 
single, primary, or secondary star.
This section will consider the effects of varying both $f_i(r)$ and also the
relative values of the $Z_i$'s.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Power law planet radius distributions}
\label{sec:model_2}

\subsubsection{Twin binaries}
We begin introducing realism by keeping all binaries as twins, but letting the 
radius distribution of planets vary.
Specifically, we take
\begin{equation}
\Gamma_i(r) = Z_i f(r) = Z_i r^\delta/\mathcal{N}_r,
\end{equation}
for $f(r)$ the radius shape function, and $\mathcal{N}_r$ the shape function's 
normalization.
The resulting apparent rate density is quite similar to that of the twin 
binary, fixed-planet case (Eq.~\ref{eq:model_1_apparent_rate_density}), except 
that the radius dependence and normalization are slightly different:
\begin{equation}
\Gamma\a(r\a) = \frac{r\a^\delta}{\mathcal{N}_r} \left[
\frac{Z_0}{1+\mu}
+
2^{\frac{\delta+1}{2} } \frac{\mu}{1+\mu} \left(Z_1 + Z_2
\right)
\right].
\label{eq:model5_apparent_rate_density}
\end{equation}
As in Sec.~\ref{sec:model_1}, $\mu = 2^{3/2} {\rm BF}/(1-{\rm BF})$.
If the $Z_i$'s are equal, the ``correction factor'' relative to the rate 
density for singles then becomes quite simple:
\begin{align}
\left. \frac{\Gamma\a(r\a)}{\Gamma_0(r)} 
\right|_{r\a\rightarrow r}
&=
\frac{1 + 2^{\frac{\delta+3}{2}}\mu}{1 + \mu}.
\label{eq:power_law_correction}
\end{align}
For the case of ${\rm BF}=0.1$, $\mu\approx 0.153$. Taking $\delta=-2.92$ from 
\citet{howard_planet_2012},  we get a correction factor $\Gamma\a/\Gamma_0 = 
1.004$.
In other words, the apparent rate density is an {\it over}estimate compared to 
the rate density of single stars, with a relative difference $\delta \Gamma_0 
= |\Gamma_0 - \Gamma\a | / \Gamma_0$ of 0.4\%.
This is quite a small effect!
Note though that it could change if the $Z_i$'s are not equal.
Also, a power law radius distribution $f(r) \propto r^\delta$ diverges for 
$\delta < 0$; \citet{howard_planet_2012}'s results indicate that this
approximation is good for $r\a\gtrsim 2r_\oplus$.
Similarly, it is nonsensical for $f(r)$ to be finite above some upper radius 
limit $r_u$, perhaps around $\approx 24r_\oplus$, based on the most inflated 
hot Jupiters.
An upper cut-off of $r_u$ would lead to smaller values of $\Gamma(r\a)$ 
down to $r_u/\sqrt{2}$, compared to an intrinsic power law without the cut-off.
We are not particularly interested in this effect; there are better 
models for hot Jupiter occurrence rates that we will discuss in 
Sec.~\ref{sec:further_models}.
If the assumptions behind this model (listed in 
Sec.~\ref{sec:general_formula}) are at all applicable in real transit surveys, 
this suggests that for $2r_\oplus \lesssim r\a \lesssim 17r_\oplus$, 
binarity's impact on derived occurrence rates is quite small.



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Varying binaries}
\label{sub:powerlaw_varying_binaries}

To confirm the intuition that non-twin binaries do not affect 
the above result, we now assume $f(q) = q^\beta/\mathcal{N}_q$, for 
$\mathcal{N}_q$ the normalization.
This changes $\mu$ (Eq.~\ref{eq:mu_general} becomes 
Eq.~\ref{eq:mu_power_laws}).
It may also affect the rate density, which could be a function of the stellar 
mass, which is now varying for secondaries (we assume that singles and 
primaries have the same mass).
Absorbing this dependence into a power law as well,
\begin{equation}
\Gamma_i(r,M) = Z_i \times \frac{r^\delta}{\mathcal{N}_r} \times
\frac{M^\gamma}{\mathcal{N}_M},
\end{equation}
where $Z_i$ is dimensionless, and the normalization constants carry 
the units (each side has units $[r^{-1} M^{-1}]$).
We assume that stars are a one-parameter family, given by $R \propto M \propto 
L^{\frac{1}{\alpha}}$, so that a given value of $q$ determines everything 
about a secondary.

Using Eq.~\ref{eq:general_Gamma_a}, we can show that when $Z_0=Z_1=Z_2$,
\begin{align}
X_\Gamma &\equiv \left. \frac{\Gamma\a(r\a,M\a)}{\Gamma_0(r,M)} 
\right|_{r\a\rightarrow r,\ M\a\rightarrow M} \\
&=
\notag
\frac{1}{1+\mu}
\left[1 + \frac{1}{\mathcal{N}_q} \frac{{\rm BF}}{1-{\rm BF}}\times 
\left(
\int {\rm d}q\,q^\beta (1+q^\alpha)^{\frac{\delta+4}{2}} +
\right.
\right. \\
&\quad\quad\quad\quad\quad\quad\quad\quad\quad\quad
\left.\left.
\int {\rm d}q\,q^{\beta+\gamma+\delta+\frac{8}{3}} 
(1+q^\alpha)^{\frac{3}{2}}
(1+q^{-\alpha})^{\frac{\delta+1}{2}}
\right)\right].
\label{eq:powerlaw_vary_binary}
\end{align}

For $\alpha = 3.5$, $\beta=0$, $\gamma=0$, $\delta=-2.92$, the 
summed integrals in Eq.~\ref{eq:powerlaw_vary_binary} give $(\ldots)\approx 
1.41425$. %171211_model_integrals.nb
For ${\rm BF}=0.44$, this yields $\Gamma\a/\Gamma_0 = 1.014$; the
apparent rate density is higher than the rate density around singles by 1.4\%.
To summarize, this model suggests that for a power-law radius distribution 
($2r_\oplus \lesssim r\a \lesssim 17r_\oplus$) in which there are the same 
number of planets orbiting singles, primaries, and secondaries, binarity 
influences apparent planet occurrence rates around Sun-like stars at the 
$\sim$few percent level.




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Fixed primaries, varying secondaries, broken power-law planets}
\label{sec:model_3}

\begin{figure}[!tb]
    \centering
    \epsscale{1.15}
    \plottwo{figures/int_rate_density_vs_radius_model_3_rpu_22.5_manyZs.pdf}{figures/int_occ_rate_vs_radius_model_3_rpu_22.5_manyZs.pdf}
    \caption{
        {\it Left:} rate density and {\it right:} rate (over $0.5r_\oplus$ 
        bins) as a function of planet radius for the distribution specified by 
        Eq.~\ref{eq:model3_radius_distribution}. This model has identical 
        primaries and single stars, and varying secondaries. We use an 
        arbitrary normalization of $Z_0=0.5$ throughout.}
    \label{fig:occ_rate_model_3_log}
\end{figure}

Though the details of the radius distribution $\Gamma_i(r)$ at $r<2r_\oplus$ 
are still an active topic of research, we can consider how binarity effects
this regime under various reasonable assumptions.
For instance, we can assume that the true radius shape function is
\begin{align}
f(r)
&\propto
\left.
\begin{cases}
r^\delta & \text{for } r\geq 2r_\oplus \\
{\rm constant} & \text{for } r\leq2r_\oplus.
\end{cases}
\right.
\label{eq:model3_radius_distribution}
\end{align}
As before, all single and primary stars in this model have identical 
properties. The secondaries have masses, radii, and luminosities that vary 
between systems: $R \propto M \propto L^{\frac{1}{\alpha}}$.
Our ``nominal model'' remains the same: 
$\alpha=3.5$, $\beta=\gamma=0$, $\delta=-2.92$.

At apparent radii $r\a > 2r_\oplus$, the results of this model are the same as 
those from Sec.~\ref{sub:powerlaw_varying_binaries}.
For $r\a < 2r_\oplus$, the equations are quite tedious, though still tractable.
To compute $\Gamma\a(r\a)$, we simply insert 
Eq.~\ref{eq:model3_radius_distribution} into Eq.~\ref{eq:general_Gamma_a}, and 
integrate using a computer program.
We refer the interested reader to our online 
implementation\footnote{\url{https://github.com/lgbouma/binary_biases}}.
The output is validated against analytic predictions in the $r\a > 
2r_\oplus$ and the $r\a < 2r_\oplus/\sqrt{2}$ regimes, and is plotted in
Fig.~\ref{fig:occ_rate_model_3_log}.


\paragraph{The rate of Earth analogs}
The most immediately arresting result there is a ``bump'' in the apparent rate 
density at $r\a < 2r_\oplus$: the true rate for singles is less than the 
inferred rate.
For the case in which secondaries host as many (half as many) planets as 
single stars, this means an overestimate of the absolute occurrence rate by 
$\approx 50\%$ ($\approx 25\%$).
The ``bump'' exists even for the $Z_2/Z_0=0$ case as a $\approx 10\%$ effect.

\paragraph{Hot Jupiter occurrence rates}
Taking Fig.~\ref{fig:occ_rate_model_3_log} and integrating the rate density, 
we can compare the apparent hot Jupiter 
occurrence rate with the true rate for singles.
In the most extreme case of $Z_2/Z_0=0$, we find that $\Lambda_{{\rm 
HJ},0}/\Lambda_{\rm HJ,a} = 1.13$, where
\begin{equation}
\Lambda_{\rm HJ,a} = \int_{8r_\oplus}^{\infty} \Gamma\a(r)\,{\rm d}r,
\end{equation}
and similarly for $\Lambda_{\rm HJ,0}$.
%occ_rate_vs_radius_model_3_withtext_Zsub2_0.00_rpu_22.5.pdf
If $Z_2/Z_0>0$, binarity affects this value less: when $Z_2/Z_0=0.5$, 
we find $\Lambda_{{\rm HJ},0}/\Lambda_{\rm HJ,a} = 1.06$


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Further models: radius gaps, Gaussian HJ distributions}
\label{sec:further_models}

The radius distribution specified by Eq.~\ref{eq:model3_radius_distribution} 
misses some important features recently reported by state of the art 
occurrence rate studies.

\paragraph{Precise features of the radius valley}

\begin{figure}[!tb]
    \centering
    \epsscale{1.15}
    \plottwo{figures/int_rate_density_vs_radius_model_4_xcut_manyZs.pdf}{figures/int_occ_rate_vs_radius_model_4_xcut_manyZs.pdf}
    \caption{
        {\it Left:} rate density and {\it right:} rate (over $0.25r_\oplus$ 
        bins) as a function of planet radius in a model with a radius gap 
        (Eq.~\ref{eq:model4_radius_distribution}).
        Similar to Fig.~\protect\ref{fig:occ_rate_model_3_log}, this model has 
        fixed primaries and single stars, but varying secondaries.
    }
    \label{fig:model_4}
\end{figure}

In particular,~\citet{fulton_california-_2017} recently reported a ``gap'' in 
the radius-period 
plane~\citep{petigura_california-kepler_2017,johnson_california-kepler_2017}.
The existence of the gap has been independently corroborated from a sample of 
KOIs with asteroseismically-determined stellar 
parameters~\citep{van_eylen_asteroseismic_2017}.
Precise measurement of the gap's features, in particular its width, 
depth, and shape, will require accurate occurrence rates.
To illustrate binarity's role in this problem, we make identical assumptions 
as in Sec.~\ref{sec:model_3}, but instead assume an intrinsic radius 
distribution
\begin{align}
f(r)
&\propto
\left.
\begin{cases}
r^\delta & \text{for } r\geq 2r_\oplus, \\
0 & \text{for } 1.5r_\oplus < r < 2r_\oplus, \\
{\rm constant} & \text{for } r\leq1.5r_\oplus.
\end{cases}
\right.
\label{eq:model4_radius_distribution}
\end{align}
The resulting true and inferred rates are shown in Fig.~\ref{fig:model_4}.
If left uncorrected, binarity makes the gap appear more shallow, and flattens 
the step-function edges.
Of course, other effects could also ``blur'' the gap in the planet radius 
dimension. 
In particular, the valley's period-dependence is almost certainly not flat
\citep{van_eylen_asteroseismic_2017,owen_evaporation_2017}.
This means that any study measuring the gap's width or depth in the face of 
binarity must either perform tests at fixed orbital period, or else 
marginalize over period and account for the associated blurring in the planet 
radius dimension.

\paragraph{Alternative models for the HJ distribution}

\begin{figure}[!tb]
    \centering
    \includegraphics[width=.6\textwidth]{figures/int_rate_density_vs_radius_model_7_rpu_22.5_manyZs.pdf}
    \caption{
        Rate density for a population of planets with true radii $r$ drawn from
        $\mathcal{N}(14r_\oplus,2r_\oplus)$.
        This is similar to the hot Jupiter distribution presented 
        by~\citet{petigura_CKS_2017}.
    }
    \label{fig:gaussian_HJ}
\end{figure}

In the recent work by~\citet{petigura_CKS_2017}, hot Jupiters appear as an 
island in period-radius space, rather than as a continuous component of a 
power law distribution.
Consider instead a Gaussian radius shape function,
\begin{equation}
f(r) \propto \exp \left( -\frac{(r-\bar{r})^2}{2\sigma^2} \right),
\end{equation}
with $\bar{r} = 14r_\oplus$ and $\sigma = 2r_\oplus$.
As always, $\Gamma_i(r) = Z_i f(r)$.
We then compute $\Gamma\a(r\a)$, and plot it in Fig.~\ref{fig:gaussian_HJ}.
Integrating to find hot Jupiter rates,
we find the opposite effect as in the power law model.
For $Z_2/Z_0>0$, 
the apparent HJ rate is {\it greater} than the true rate for singles.
The effect is maximal when there are as many hot Jupiters orbiting secondaries 
as singles, in which case
$\Lambda_{{\rm HJ},0}/\Lambda_{\rm HJ,a} = 0.84$
For the case when no hot Jupiters orbit secondaries, $\Lambda_{{\rm HJ},0} 
\approx \Lambda_{\rm HJ,a}$ to within one percent.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\input{discussion}

\section{Discussion}
\label{sec:discussion}

\paragraph{How has binarity been considered in occurrence rate measurements?}
This study has shown that under a reasonable set of simplifying assumptions, 
binarity can introduce systematic errors to star and planet counts in transit 
surveys, which then bias derived occurrence rates.
Thus far, real-world occurrence rate calculations\footnote{
    A list of occurrence rate papers is maintained at 
    \url{https://exoplanetarchive.ipac.caltech.edu/docs/occurrence_rate_papers.html}
} using transit survey data have mostly ignored stellar 
multiplicity~\citep[\textit{e.g.},][]{howard_planet_2012,fressin_false_2013,foreman-mackey_exoplanet_2014,dressing_occurrence_2015,burke_terrestrial_2015}.
For {\it Kepler} occurrence rates specifically, 
it seems that no one has yet carefully assessed binarity's importance, or lack 
thereof.
While we do not resolve the problem, we do suggest the approximate scale of 
the necessary corrections in a survey-independent manner.

Of course, on a system-by-system level stellar multiplicity affects the 
interpretation of planet candidates. High resolution imaging 
campaigns have measured the multiplicity of almost all {\it Kepler}\ Objects 
of Interest 
\citep{howell_speckle_2011,adams_adaptive_2012,adams_adaptive_2013,horch_observations_2012,
    horch_most_2014,lillo-box_multiplicity_2012,lillo-box_high-resolution_2014,dressing_adaptive_2014,
    law_robotic_2014,cartier_revision_2015,everett_high-resolution_2015,gilliland_hubble_2015,
    wang_influence_2015,wang_influence_2015-1,baranec_robo-ao_2016,ziegler_robo-ao_2017}.
The results of these programs have been collected 
by~\citet{furlan_kepler_2017}, and they represent an important advance in 
understanding the KOI 
sample's multiplicity statistics.
In particular, they can be immediately applied to rectify binarity's effects 
on the mass-radius diagram~\citep{furlan_densities_2017}.

The high resolution imaging campaign is also beginning to connect with
occurrence rate calculations.
The most recent rate studies have used~\citet{furlan_kepler_2017}'s 
catalog to test the effects of removing KOI hosts with known companions, which 
helps reduce contamination in the ``numerator'' of 
the occurrence rate (\citealt{fulton_california-_2017}; 
\citealt{petigura_CKS_2017}).
However, without an understanding of the multiplicity statistics of the 
non-KOI stars, the true number of searchable stars, and thus the true 
occurrence rates, will remain biased.
The first-order correction that we suggest, given the impracticality of 
performing high-resolution imaging of every star searched by a transit 
survey, is to model the detection pipeline's efficiency while accounting for 
binarity.
For {\it Kepler}, this would require high resolution imaging of a
comparison sample of non-KOI host stars. If the associated multiplicity 
statistics are then included in a model of the pipeline's detection 
efficiency, and the number of searchable stars is appropriately counted (at a 
given $\delta_{\rm obs}$), it would correct many of binarity's biases.


\paragraph{The rate of Earth analogs}
Per {\it Kepler}'s primary science objective, the rate of Earth-like planets 
orbiting Sun-like stars has been independently measured by 
\citet{youdin_exoplanet_2011,petigura_prevalence_2013,dong_fast_2013,
    foreman-mackey_exoplanet_2014}, and \citet{burke_terrestrial_2015}.
These efforts have found that the one-year terrestrial planet occurrence rate 
varies between $\approx 0.03$ and $\approx 1$ per Sun-like star, depending on 
assumptions that are made when retrieving the rate 
(\citealt{burke_terrestrial_2015}'s Fig.~17).
In the power law model of Sec.~\ref{sec:model_3}, the inferred rate can be up 
to 50\% higher than the true rate around single stars.
Though this bias seems large, it is currently small compared to the other 
systematic factors that dominate the dispersion in $\eta_\oplus$ 
measurements.
If a future analyses determine absolute values of $\eta_\oplus$ to 
better than a factor of two, binarity might merit closer attention.

One relevant caveat to our assessment of binarity's importance for 
$\eta_\oplus$ measurements is that none of our models 
included the rate density's period-dependence. However, close binaries usually
provoke dynamical instabilities, leading to fewer long-period planets per 
star~\citep[\textit{e.g.},][]{holman_long-term_1999,wang_influence_2014,
    kraus_impact_2016}.
This effect might further bias transit survey measurements of $\eta_\oplus$
beyond our rough estimate.


\paragraph{The hot Jupiter rate discrepancy}
There is at least one context in which ignoring binarity has been suggested as 
a possible source of discrepant occurrence rate measurements.
Hot Jupiter occurrence rates measured by transit surveys ($\approx 0.5\%$) are 
marginally lower than those found by radial velocity surveys ($\approx 1\%$; 
see Table~\ref{tab:hj_rates}).
Though the discrepancy has weak statistical significance ($<3\sigma$),
one reason to expect a difference is that the corresponding stellar 
populations have distinct metallicities.
As argued by \citet{gould_frequency_2006}, the RV sample is biased towards 
metal-rich stars, which have been measured by RV surveys to preferentially 
host more giant 
planets~\citep{santos_spectroscopic_2004,fischer_planet-metallicity_2005}.
Investigating the discrepancy from the metallicty 
angle,~\citet{guo_metallicity_2017} measured the
{\it Kepler} field's mean metallicity to be $[{\rm M/H}]_{\rm Kepler}= 
-0.045\pm0.009$, which is lower than the California Planet Search's mean of 
$[{\rm M/H}]_{\rm CPS}= -0.005\pm0.006$.
The former value agrees with that measured by \citet{dong_metallicities_2014}.
Refitting for the metallicity exponent in $\Lambda_{\rm HJ} \propto 10^{\beta 
[{\rm M/H}] }$, \citeauthor{guo_metallicity_2017}\! found $\beta = 2.1\pm 
0.7$, and noted that this would imply that the metallicity difference could 
account for a $\approx 20\%$ relative difference in the measured rates between 
the CKS and {\it Kepler}\ samples~--~not a factor of two\footnote{
\citet{petigura_CKS_2017} recently found $\beta = 3.4^{0.9}_{-0.8}$.
This gives an $\approx 25\%$ relative difference, indicating metallicity could 
account for at least half of the ``hot Jupiter rate discrepancy''.
}.
\citeauthor{guo_metallicity_2017}\! concluded that ``other factors, such as 
binary contamination and imperfect stellar properties'' must also be at play.

Aside from surveying stars of varying metallicities, radial velocity and 
transit surveys differ in how they treat binarity.
Radial velocity surveys typically reject both visual and spectroscopic binaries
\citep[\textit{e.g.},][]{wright_frequency_2012}.
Transit surveys typically observe binaries, but the question of whether they 
were searchable to begin with is left for later interpretation.
In spectroscopic follow-up of candidate transiting planets, the prevalence of 
astrophysical false-positives may also lead to a bias against confirmation of 
transiting planets in binary systems.

Ignoring these complications, in this work we showed that
binarity biases transit survey occurrence rates through its effects on 
star counts and the apparent radii of detected planets.
Our results from Sec.~\ref{sec:model_3} indicate that binarity 
could lead to underestimated HJ rates relative to singles by a multiplicative 
factor of at most $\approx 1.13$ (assuming a power-law radius distribution, 
and that no secondaries host HJs).
We later pointed out in Sec.~\ref{sec:further_models} that assuming a 
power-law radius distribution is probably wrong if one wishes to study the HJ 
rate discrepancy. If we instead assumed a 
Gaussian radius distribution~\citep[following][]{petigura_CKS_2017}, apparent 
HJ rates are actually {\it greater} 
than the true rate around singles.
\begin{comment}
If we believe the assumed power-law radius distribution, we can ask whether 
this ``correction factor'' might help resolve the discrepancy.
Explicitly, we ask: what is the probability of \citet{wright_frequency_2012}'s 
result, given a rate drawn from the stated bounds of~\citet{petigura_CKS_2017}?
In other words, we first take the true HJ rate per thousand stars as 
$\Lambda_{\rm HJ} = 5.7 \pm 1.3$, with Gaussian uncertainties. 
We then draw from a Poisson distribution and compute the probability of 
detecting at least 10 hot Jupiters in a sample of 836 stars.
Without accounting for binarity or metallicity, only 4\% of RV surveys would 
detect at least 10 hot Jupiters.
If we multiply $\Lambda_{\rm HJ}$ by $1.2$ to account 
for~\citet{guo_metallicity_2017}'s measured metallicity difference between the 
{\it Kepler}\ field and the local solar neighborhood, 9\% of RV surveys would 
detect at least 10 hot Jupiters.
If we multiply once more by $1.13$ to account for binarity's supposed bias, we 
find that 14\% of RV surveys would detect at least 10 hot Jupiters, still 
suggesting a weak discrepancy.

This suggestion should be taken with caution, because it (likely incorrectly) 
assumes a power-law radius distribution.
\end{comment}
This means that assuming a Gaussian similar to that reported 
by~\citet{petigura_CKS_2017}, binarity is unlikely to resolve the HJ rate 
discrepancy.
Of course, such calculations can be at most suggestive~--~a true resolution 
of binarity's effects may require a detailed understanding of the 
{\it Kepler}\ field's multiplicity statistics, and the mission's completeness 
(both for candidate detection and follow-up).
For instance, if hot Jupiters are less likely to be confirmed in binary 
systems, this might bias the rates low.




\paragraph{Does a detected planet orbit the primary or secondary?}
\citet{ciardi_understanding_2015} studied the effects of stellar multiplicity 
on the planet radii derived from transit surveys.
They modeled the problem for {\it Kepler}\ objects of interest by matching a 
population of binary and tertiary companions to KOI stars, 
under the assumption that the KIC-listed stars were the primaries.
They then computed planet radius correction factors assuming that {\it 
    Kepler}-detected planets orbited the primary or companion stars
with equal probability (their Sec.~5).
Under these assumptions, they found that any given planet's radius is on 
average underestimated by a multiplicative factor of $\approx\! 1.5$.
\citet{ziegler_robo-ao_2017} recently reported a similar value for the real
population of systems observed by the Robo-AO KOI survey, under the same 
assumption.

Our models indicate that assuming a detected planet has equal probability of 
orbiting the primary or secondary leads to an overestimate of
binarity's population-level effects.
A planet orbiting the secondary does lead to extreme corrections, but these 
cases are rare outliers, because the searchable volume for secondaries is so 
much smaller than that for primaries (see~Fig.~\ref{fig:model_1_volumes}).
This means that when high-resolution imaging discovers a binary companion in 
a system that hosts a detected transiting planet, the planet is much
more likely to orbit the primary.
This statement is independent of the fact that planets are often confirmed to 
orbit the primary by inferring the stellar density from the transit duration.


\paragraph{On completeness}
{\bf TODO THIS SECTION}
This is if some fraction of stars you thought were searchable are not. There 
are no such stars.

Our expressions for the apparent rate density 
(Eqs.~\ref{eq:defn_apparent_rate_density} 
and~\ref{eq:model_1_apparent_rate_density}) do not explicitly mention 
detection efficiency.
If we were to take a smooth detection probability in S/N, we would need to 
include an explicit detection efficiency term in 
Eq.~\ref{eq:defn_apparent_rate_density} to inversely weight for planets 
that had low probabilities of being detected.
However, our ``detection probability'' is a step function in S/N 
(Eq.~\ref{eq:S_N_thresh}).
In our model, the maximum searchable distance is only a function of the 
apparent depth and true system luminosity.
Even though the observers are selecting stars based on what they think are 
``true radii'' (bottom row of Fig.~\ref{fig:model_1_volumes}), the 
actual searchability of a point-source is determined by apparent radius and 
system luminosity (Eq.~\ref{eq:S_N_thresh}; top rows of 
Fig.~\ref{fig:model_1_volumes}).
Thus at a given apparent radius $r\a$, the stars (single or binary) that are 
searchable are exactly the stars that are SEARCHED, since dilution affects the 
apparent radius and the maximum searchable distance in equal and opposite 
order.



\paragraph{Utility in future occurrence rate measurements}
{\it TESS}\ is expected to discover over $10^4$ giant 
planets~\citep{ricker_transiting_2014,sullivan_transiting_2015}.
Though they will be difficult to distinguish from false positives, one 
possible use of this large sample will to measure an occurrence rate of 
short-period giant planets with minimal error from counting statistics.
Our models suggest that binarity will only become an appreciable fraction of 
the error budget at the $\approx 10\%$ precision level.
This should be sufficient for a rate measurement precise enough to indicate a 
preference between $\approx 0.5\%$ and $\approx 1\%$ of Sun-like stars hosting 
hot Jupiters.

\begin{comment}
\paragraph{Independent approaches for estimating binarity's effects}
T. Barclay et al.\! (in preparation) have performed the exercise of taking 
stars selected by the {\it Kepler}\ team, pairing them with a population of 
secondaries, injecting a realistic distribution of planet radii, 
and then comparing the inferred occurrence rates with the true ones.
In their model, they find that binarity leads to an inferred rate of 
Earth-sized planets $\approx 10\%$ less than the true rate.
In our Model \#3, if all $Z_i$'s are equal (a plausible assumption in 
the lack of evidence to the contrary), the underestimate is by a comparable 
16\%.
\end{comment}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\input{conclusion}

\section{Conclusion}
\label{sec:conclusion}

This study presented simple models for the effects of binarity on occurrence 
rates measured by transit surveys.
The simplest of these models (Sec.~\ref{sec:simplest}) provided an 
order-of-magnitude estimate for how much binarity might affect occurrence 
rates: by no more than $\sim$factors of two.

We then gave a general formula for the apparent rate density inferred by an 
observer ignoring binarity (Eq.~\ref{eq:general_Gamma_a}).
As input, this equations requires a volume-limited mass ratio distribution 
$f(q)$, and also the true rate densities for planets around singles, 
primaries, and secondaries.
The assumptions that make the model tractable are:
\begin{enumerate}
    \item the transit survey is S/N limited;
    \item all the primaries and single stars have identical properties;
    \item the properties of the secondaries can vary, but there are known 
    functions $L(M)$ and $R(M)$ that specify a star's luminosity and radius in 
    terms of its mass;
    \item the binarity-ignoring observers assume that binaries have the same 
    properties as the primaries.
\end{enumerate}

Allowing for these conditions, many results follow:
\begin{itemize}
%
\item Assuming a power-law planet radius distribution, and that the same 
number of planets orbit singles, primaries, and secondaries, binarity 
influences apparent planet occurrence rates around Sun-like stars at the 
$\sim$few percent level from radii $2r_\oplus \lesssim r\a \lesssim 
17r_\oplus$ (Sec.~\ref{sec:model_2}).
%
\item Assuming a broken-power law planet radius distribution, with 
\citet{howard_planet_2012}'s exponent at $r > 2r_\oplus$ and a constant 
occurrence at $r < 2r_\oplus$, there is a ``bump'' in the apparent rate 
density at $r\a < 2r_\oplus$, leading to a relative error $\delta \Gamma_0 = 
|\Gamma_0 - \Gamma\a|/\Gamma_0$ of at most $\approx 50\%$ 
(Fig.~\ref{fig:occ_rate_model_3_log}).
Although this is smaller than current systematic uncertainties on the 
occurrence rates of Earth-sized planets, this means that binarity could
eventually become an important component of the $\eta_\oplus$ error budget.
%
\item Binarity ``fills in'' gaps in the radius distribution 
(Fig.~\ref{fig:model_4}), by an amount that could affect precise measurements 
of the depth, width, and slope of \citet{fulton_california-_2017}'s radius 
gap, in the event that planets are not carefully vetted with high resolution 
imaging.
This will likely become an important consideration for precise measurements of 
the depth, width, and slope of .
%
\item Binarity does not lead to smaller apparent HJ occurrence rates 
(Fig.~\ref{fig:gaussian_HJ}).
This assumes a Gaussian planet radius distribution, similar to that reported 
by~\citet{petigura_CKS_2017}.
\end{itemize}

All of these results should be understood as only being strictly applicable 
when the assumptions listed above are met.
Otherwise, they are only suggestive.
{\bf TODO: finish}





\acknowledgements{
It was a pleasure discussing this work with F. Dai and T. Barclay.

\software{\texttt{numpy}~\citep{walt_numpy_2011}, 
\texttt{scipy}~\citep{jones_scipy_2001}, 
\texttt{matplotlib}~\citep{hunter_matplotlib_2007}, 
\texttt{pandas}~\citep{mckinney-proc-scipy-2010}
}
}

\newpage
\appendix
\section{Derivation of general formula for apparent occurrence rate}
\label{sec:appendix}
Recall our definition of apparent rate density 
(Eq.~\ref{eq:defn_apparent_rate_density}).
Let us explicitly write $\pp=r$ and $\ps=M$; $R$ and $L$ are uniquely 
determined from the assumed stellar mass--radius--luminosity relation. We 
neglect the dependence on planetary orbital period.
The planets with $(r\a, M\a)$ are associated with 
systems of many different planetary and stellar properties, so $n_{\rm 
det}(r\a, M\a)$ is given by the convolution of the true rate density, 
$\Gamma(r, M)$, and $\mathcal{N}(r\a, M\a; r, M)$, the number (per 
unit $(r\a, M\a)$) of searchable stars that give $(r\a, M\a)$  when 
the true system actually has $(r, M)$. Mathematically,
\begin{align}
n_{\rm det}(r_a, M_a) &=
\sum_i n_{\rm det}^i(r_a, M_a) \\
&=
\sum_i \int \mathrm{d}r \mathrm{d}M \,
\mathcal{N}_{\rm s}^i(r_a,M_a; r,M)
\cdot\Gamma_i(r,M) \cdot p_{\rm tra}(r,M),
\label{eq:n_det}
\end{align}
where $i$ specifies the type of true host stars (0: single, 1: primary, 2: 
secondary).
The problem reduces to the evaluation of
\begin{equation}
\mathcal{N}_{\rm s}^i(\pp\a,\ps\a; \pp, \ps)
\end{equation}
for planets around single stars, primaries in binaries, and secondaries in 
binaries. 

\paragraph{Single stars} For $i=0$, 
\begin{equation}
\mathcal{N}_{\rm s}^0(r\a,M\a; r,M)
=\delta(r\a-r)\delta(M\a-M) N\s^0(r,M),
\end{equation}
so
\begin{equation}
n_{\rm det}^0(r\a, M\a)=N\s^0(r\a,M\a)\cdot \Gamma_0(r\a, 
M\a) \cdot p_{\rm tra}(r\a, M\a).
\end{equation}

\paragraph{Primaries in binaries}
The number of primaries with apparent parameters $(r_a,M_a)$ given the 
true parameters $(r,M)$ is
\begin{equation}
\mathcal{N}_{\rm s}^1(r_a, M_a; r, M)
=\int \mathrm{d}q\,f(q)\mathcal{N}_{{\rm s}, q}^1(r_a, M_a, q; r, M),
\label{eq:fancyN_s_1}
\end{equation}
where $f(q)$ is the volume-limited binary mass ratio distribution.

Since we assume $\ps\a=\ps_1$,
\begin{equation}
\mathcal{N}_{{\rm s},q}^1(r_a, M_a, q; r, M) \propto \delta(M_a-M).
\end{equation}
In this case, $\mathcal{N}_{{\rm s},q}^1$ is non-zero only at 
$r_a=R_a\sqrt{\delta_{\rm obs}}$, 
and the observed depth is
\begin{equation}
\delta_{\rm obs}
= \left[{r\over R(M_a)}\right]^2\times {L(M_a) \over L_{\rm sys}(M_a, q)}
\equiv \left[{r\over R(M_a)}\right]^2\times \mathcal{A}(q,M\a)^2
\label{eq:delta_obs_primaries} 
\end{equation}
The normalization of $\mathcal{N}_{{\rm s},q}^1$ is given by the number of 
binaries that are searchable for a signal $\delta_{\rm obs}$ and that have the 
mass ratio $q$:
\begin{equation}
N_{\rm s}^0(\delta_{\rm obs}, 
L(M_a))\cdot
{n_b\over n_s}\left[L_{\rm sys}(M_a, q) \over L(M\a)\right]^{3/2}
=N_{\rm s}^0(\delta_{\rm obs}, L(M_a))
\cdot \frac{{\rm BF}}{1 - {\rm BF}} \cdot {1 \over \mathcal{A}(q,M\a)^3}.
\label{eq:primary_normalization}
\end{equation}

Thus,
\begin{align}
\notag
\mathcal{N}_{{\rm s}, q}^1(r_a, M_a, q; r, M)
&=N_{\rm s}^0(\delta_{\rm obs}, L(M_a))
\cdot \frac{{\rm BF}}{1 - {\rm BF}} \cdot {1 \over \mathcal{A}(q,M\a)^3}\\
&\times\delta \left[r_a-r\mathcal{A}(q,M\a)\right]\delta(M_a-M).
%&=N_{\rm s}^0(\delta_{\rm obs}, L(M_a))\cdot\mu(\mathrm{BF},M_a)\\
%&\times\delta \left(r_a-r\sqrt{{L(M_a) \over L_{\rm sys}(M_a, 
%q)}}\right)\delta(M_a-M).
\label{eq:N_s_1}
\end{align}


\paragraph{Secondaries in binaries}
In this case, $M=qM_1=qM_a$, so
\begin{equation}
\mathcal{N}_{{\rm s},q}^2(r_a, M_a, q; r, M)
\propto \delta\left(M_a-{M\over q}\right).
\label{eq:fancyN_s_2_prop}
\end{equation}
Again $\mathcal{N}_{\rm s}^2$ is non-zero only at $r_a=R_a\sqrt{\delta_{\rm 
        obs}}$, but this 
time
\begin{equation}
\delta_{\rm obs} = \left[{r\over R(qM_a)}\right]^2 \times {L(qM_a) 
    \over L_{\rm sys}(M_a, q)}.
\end{equation}
The normalization remains the same as the previous case (we are counting the 
searchable stars at a given observed depth $\delta_{\rm obs}$, total 
luminosity of the binary is the same).
Thus,
\begin{equation}
\mathcal{N}_{\rm s}^2(r_a, M_a; r, M)
=\int \mathrm{d}q\,f(q)\mathcal{N}_{{\rm s}, q}^2(r_a, M_a, q; r, M),
\end{equation}
where
\begin{align}
\notag
\mathcal{N}_{\rm s}^2(r_a, M_a; r, M; q)
&=N_{\rm s}^0(\delta_{\rm obs}, L(M_a)) \cdot \frac{{\rm BF}}{1 - {\rm BF}} 
\cdot {1 \over \mathcal{A}(q,M\a)^3}\\
&\times \delta \left(r_a-r\sqrt{ \left[{R(M_a)\over R(qM_a)}\right]^2 
    {L(qM_a) 
        \over L_{\rm sys}(M_a, q)} }\right)\delta\left(M_a-{M\over q}\right).
\label{eq:mathcal_N_s_2}
\end{align}

One might worry in Eq.~\ref{eq:mathcal_N_s_2} that we opt to write 
$\mathcal{N}\s^2 \propto \delta(M_a - M/q)$, rather than $\propto \delta(M_a q 
- M)$ or some other delta function with the same functional dependence, 
but a different normalization once integrated.
We do this because the delta function in Eq.~\ref{eq:mathcal_N_s_2} is 
defined with respect to the measure ${\rm d}M\a$, not ${\rm d}M$.
This is because $\mathcal{N}\s^2$ is defined as a number per $r\a$, per $M\a$.

\paragraph{Number of detected planets}
Marginalizing per Eq.~\ref{eq:n_det}, we find
\begin{align}
\notag
n_{\rm det}^0(r\a, M\a)
&=\int\mathrm{d}r\mathrm{d}M\,\mathcal{N}_{\rm s}^0(r\a, M\a; r, M)
\cdot\Gamma_0(r, M) \cdot p_{\rm tra}(M)\\
&=N\s^0(\delta_{\rm obs}, L(M\a))\cdot\Gamma_0(r\a, M\a) \cdot p_{\rm 
    tra}(M\a),
\end{align}
and
\begin{align}
\notag
n_{\rm det}^1(r\a, M\a)
&=\int\mathrm{d}r\mathrm{d}M\,\mathcal{N}_{\rm s}^1(r\a, M\a; r, M)
\cdot\Gamma_1(r, M) \cdot p_{\rm tra}(M)\\
&=N\s^0(\delta_{\rm obs}, L(M\a))\cdot p_{\rm tra}(M\a) \cdot
{\mathrm{BF}\over{1-\mathrm{BF}}} \int {\mathrm{d}q \over 
    \mathcal{A}^4}\,f(q)\,\Gamma_1\left({r_a\over\mathcal{A}}, M\a\right),
\end{align}
where
\begin{equation}
\mathcal{A}(q, M\a)=\sqrt{L(M\a) \over L_{\rm sys}(M\a, q)}.
\end{equation}
Finally,
\begin{align}
n_{\rm det}^2(r\a, M\a)
&=\int\mathrm{d}r\mathrm{d}M\,\mathcal{N}_{\rm s}^2(r\a, M\a; r, M)
\cdot\Gamma_2(r, M) \cdot p_{\rm tra}(M)\\
&=
N\s^0(\delta_{\rm obs}, L(M\a))\cdot \frac{{\rm BF}}{1 - {\rm BF}}
\int {q \mathrm{d}q \over 
{\mathcal{A}^3\mathcal{B}}}\,f(q)\,\Gamma_2(r_a/\mathcal{B}, 
qM\a)\,p_{\rm 
    tra}(qM\a),
\end{align}
where
\begin{equation}
\mathcal{B}(q, M\a)={R(M\a)\over R(qM\a)}\sqrt{{L(qM\a) \over L_{\rm 
            sys}(M\a, q)} }.
\end{equation}


\paragraph{General formula for apparent occurrence rate}
Using the results above, the apparent rate density,
\begin{align}
\Gamma\a(r\a,M\a) &= 
\frac{1}{N_{\rm s,a}(r\a,M\a) p_{\rm tra}(r\a,M\a)} \times
\sum_i n_{\rm det}^i (r\a,M\a),
\end{align}
evaluates to

\begin{align}
\notag
\Gamma\a(r\a,M\a) &= {1\over 1+\mu(\mathrm{BF}, M\a)}\times
\left\{ \Gamma_0(r\a, M\a)+ 
\frac{{\rm BF}}{1 - {\rm BF}}
\left[ \int {\mathrm{d}q \over \mathcal{A}^4}\,f(q)\,\Gamma_1\left({r\a\over 
    \mathcal{A}}, 
M\a\right)\,
\right.   
\right. \\
& \quad\quad\quad\quad\quad \left.\left.
+\int {q \mathrm{d}q \over 
    {\mathcal{A}^3\mathcal{B}}}\,f(q)\,\Gamma_2\left({r\a\over 
    \mathcal{B}}, 
qM\a\right)\,
{R(qM\a) \over R(M\a)}
q^{-1/3} \right]	\right\}.
\end{align}
This equation is used to derive Eqs.~\ref{eq:model5_apparent_rate_density} 
and~\ref{eq:powerlaw_vary_binary}, and is numerically integrated to create 
Figs.~\ref{fig:occ_rate_model_3_log},~\ref{fig:model_4}, 
and~\ref{fig:gaussian_HJ}.
It is validated in limits in which it is possible to write down the answer 
(e.g., Eq.~\ref{eq:model_1_apparent_rate_density}), and also against a Monte 
Carlo realization of the twin binary models (Secs.~\ref{sec:model_1} 
and~\ref{sec:model_2}).


\newpage
\input{hj_rates.tex}


\newpage
\bibliographystyle{yahapj}                            
\bibliography{bibliography} 

\end{document}
